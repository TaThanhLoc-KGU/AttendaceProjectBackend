<!-- Dynamic Sidebar Component -->
<!-- File: sidebar.html (Thymeleaf fragment) -->
<nav class="sidebar" id="sidebar" th:fragment="sidebar">
    <div class="sidebar-brand">
        <h4><i class="fas fa-graduation-cap me-2"></i>Face Attendance</h4>
    </div>

    <ul class="sidebar-nav" id="sidebarNav">
        <!-- Navigation items will be populated by JavaScript -->
    </ul>
</nav>

<!-- Sidebar Configuration Script -->
<script th:fragment="sidebar-script">
    // Sidebar Configuration
    const SidebarConfig = {
        // Menu items configuration with role permissions
        menuItems: [
            // Dashboard - Available for all roles
            {
                id: 'dashboard',
                label: 'Dashboard',
                icon: 'fas fa-tachometer-alt',
                url: '/dashboard', // Will be resolved by role
                roles: ['ADMIN', 'GIANGVIEN', 'SINHVIEN'],
                order: 1
            },

            // ADMIN MENU ITEMS
            {
                id: 'khoa',
                label: 'Quáº£n lÃ½ Khoa',
                icon: 'fas fa-university',
                url: '/admin/khoa',
                roles: ['ADMIN'],
                order: 10
            },
            {
                id: 'nganh',
                label: 'Quáº£n lÃ½ NgÃ nh',
                icon: 'fas fa-sitemap',
                url: '/admin/nganh',
                roles: ['ADMIN'],
                order: 11
            },
            {
                id: 'monhoc',
                label: 'Quáº£n lÃ½ MÃ´n há»c',
                icon: 'fas fa-book',
                url: '/admin/monhoc',
                roles: ['ADMIN'],
                order: 12
            },
            {
                id: 'giangvien',
                label: 'Quáº£n lÃ½ Giáº£ng viÃªn',
                icon: 'fas fa-chalkboard-teacher',
                url: '/admin/giangvien',
                roles: ['ADMIN'],
                order: 13
            },
            {
                id: 'sinhvien',
                label: 'Quáº£n lÃ½ Sinh viÃªn',
                icon: 'fas fa-user-graduate',
                url: '/admin/sinhvien',
                roles: ['ADMIN'],
                order: 14
            },
            {
                id: 'lop',
                label: 'Quáº£n lÃ½ Lá»›p',
                icon: 'fas fa-users',
                url: '/admin/lop',
                roles: ['ADMIN'],
                order: 15
            },
            {
                id: 'camera',
                label: 'Quáº£n lÃ½ Camera',
                icon: 'fas fa-video',
                url: '/admin/camera',
                roles: ['ADMIN'],
                order: 16
            },
            {
                id: 'diemdanh-admin',
                label: 'BÃ¡o cÃ¡o Äiá»ƒm danh',
                icon: 'fas fa-clipboard-check',
                url: '/admin/diemdanh',
                roles: ['ADMIN'],
                order: 17
            },
            {
                id: 'taikhoan',
                label: 'Quáº£n lÃ½ TÃ i khoáº£n',
                icon: 'fas fa-user-cog',
                url: '/admin/taikhoan',
                roles: ['ADMIN'],
                order: 18
            },
            {
                id: 'system-settings',
                label: 'CÃ i Ä‘áº·t Há»‡ thá»‘ng',
                icon: 'fas fa-cog',
                url: '/admin/settings',
                roles: ['ADMIN'],
                order: 19
            },

            // GIANGVIEN MENU ITEMS
            {
                id: 'my-courses',
                label: 'MÃ´n há»c cá»§a tÃ´i',
                icon: 'fas fa-book-open',
                url: '/lecturer/courses',
                roles: ['GIANGVIEN'],
                order: 20
            },
            {
                id: 'my-classes',
                label: 'Lá»›p há»c cá»§a tÃ´i',
                icon: 'fas fa-users',
                url: '/lecturer/classes',
                roles: ['GIANGVIEN'],
                order: 21
            },
            {
                id: 'attendance-management',
                label: 'Quáº£n lÃ½ Äiá»ƒm danh',
                icon: 'fas fa-clipboard-check',
                url: '/lecturer/attendance',
                roles: ['GIANGVIEN'],
                order: 22
            },
            {
                id: 'schedule',
                label: 'Lá»‹ch giáº£ng dáº¡y',
                icon: 'fas fa-calendar-alt',
                url: '/lecturer/schedule',
                roles: ['GIANGVIEN'],
                order: 23
            },
            {
                id: 'student-list',
                label: 'Danh sÃ¡ch Sinh viÃªn',
                icon: 'fas fa-user-graduate',
                url: '/lecturer/students',
                roles: ['GIANGVIEN'],
                order: 24
            },
            {
                id: 'reports',
                label: 'BÃ¡o cÃ¡o',
                icon: 'fas fa-chart-bar',
                url: '/lecturer/reports',
                roles: ['GIANGVIEN'],
                order: 25
            },

            // SINHVIEN MENU ITEMS
            {
                id: 'my-attendance',
                label: 'Äiá»ƒm danh cá»§a tÃ´i',
                icon: 'fas fa-clipboard-check',
                url: '/student/attendance',
                roles: ['SINHVIEN'],
                order: 30
            },
            {
                id: 'my-schedule',
                label: 'Lá»‹ch há»c',
                icon: 'fas fa-calendar-alt',
                url: '/student/schedule',
                roles: ['SINHVIEN'],
                order: 31
            },
            {
                id: 'my-courses-student',
                label: 'MÃ´n há»c',
                icon: 'fas fa-book',
                url: '/student/courses',
                roles: ['SINHVIEN'],
                order: 32
            },
            {
                id: 'face-registration',
                label: 'ÄÄƒng kÃ½ KhuÃ´n máº·t',
                icon: 'fas fa-user-check',
                url: '/student/face-register',
                roles: ['SINHVIEN'],
                order: 33
            },
            {
                id: 'profile',
                label: 'Há»“ sÆ¡ cÃ¡ nhÃ¢n',
                icon: 'fas fa-user',
                url: '/student/profile',
                roles: ['SINHVIEN'],
                order: 34
            },

            // SHARED MENU ITEMS
            {
                id: 'notifications',
                label: 'ThÃ´ng bÃ¡o',
                icon: 'fas fa-bell',
                url: '/notifications',
                roles: ['ADMIN', 'GIANGVIEN', 'SINHVIEN'],
                order: 90
            },
            {
                id: 'help',
                label: 'Trá»£ giÃºp',
                icon: 'fas fa-question-circle',
                url: '/help',
                roles: ['ADMIN', 'GIANGVIEN', 'SINHVIEN'],
                order: 99
            }
        ],

        // Initialize sidebar
        init() {
            console.log('ðŸŽ¯ Initializing dynamic sidebar...');
            this.renderSidebar();
            this.setActiveItem();
            console.log('âœ… Sidebar initialized');
        },

        // Get user role from Common.auth or localStorage
        getUserRole() {
            // Try to get from Common.auth first
            if (window.Common && Common.auth) {
                const user = Common.auth.getCurrentUser();
                if (user && user.role) {
                    return user.role.toUpperCase();
                }
            }

            // Fallback to localStorage
            try {
                const user = localStorage.getItem('user');
                if (user) {
                    const userData = JSON.parse(user);
                    if (userData.role) {
                        return userData.role.toUpperCase();
                    }
                    if (userData.vaiTro) {
                        return userData.vaiTro.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error parsing user data:', error);
            }

            console.warn('Could not determine user role, defaulting to SINHVIEN');
            return 'SINHVIEN';
        },

        // Get current page path
        getCurrentPath() {
            return window.location.pathname;
        },

        // Filter menu items by user role
        getMenuItemsByRole(userRole) {
            return this.menuItems
                .filter(item => item.roles.includes(userRole))
                .sort((a, b) => a.order - b.order);
        },

        // Resolve dashboard URL by role
        resolveDashboardUrl(userRole) {
            switch (userRole) {
                case 'ADMIN':
                    return '/admin/dashboard';
                case 'GIANGVIEN':
                    return '/lecturer/dashboard';
                case 'SINHVIEN':
                    return '/student/dashboard';
                default:
                    return '/';
            }
        },

        // Render sidebar navigation
        renderSidebar() {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) {
                console.error('Sidebar nav element not found');
                return;
            }

            const userRole = this.getUserRole();
            const menuItems = this.getMenuItemsByRole(userRole);

            console.log(`Rendering sidebar for role: ${userRole}`);
            console.log(`Menu items count: ${menuItems.length}`);

            const menuHtml = menuItems.map(item => {
                // Resolve dashboard URL
                let url = item.url;
                if (item.id === 'dashboard') {
                    url = this.resolveDashboardUrl(userRole);
                }

                return `
                    <li class="nav-item">
                        <a href="${url}" class="nav-link" data-menu-id="${item.id}">
                            <i class="${item.icon}"></i>
                            <span class="nav-text">${item.label}</span>
                        </a>
                    </li>
                `;
            }).join('');

            sidebarNav.innerHTML = menuHtml;
        },

        // Set active menu item based on current path
        setActiveItem() {
            const currentPath = this.getCurrentPath();
            const navLinks = document.querySelectorAll('.sidebar .nav-link');

            // Remove active class from all items
            navLinks.forEach(link => link.classList.remove('active'));

            // Find and set active item
            let activeLink = null;

            // First try exact match
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    activeLink = link;
                }
            });

            // If no exact match, try partial match (for sub-pages)
            if (!activeLink) {
                navLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href !== '/' && currentPath.startsWith(href)) {
                        if (!activeLink || href.length > activeLink.getAttribute('href').length) {
                            activeLink = link;
                        }
                    }
                });
            }

            // Set active class
            if (activeLink) {
                activeLink.classList.add('active');
                console.log(`Active menu item: ${activeLink.getAttribute('data-menu-id')}`);
            }
        },

        // Add new menu item dynamically
        addMenuItem(item) {
            this.menuItems.push(item);
            this.renderSidebar();
            this.setActiveItem();
        },

        // Remove menu item
        removeMenuItem(itemId) {
            this.menuItems = this.menuItems.filter(item => item.id !== itemId);
            this.renderSidebar();
            this.setActiveItem();
        },

        // Update menu item
        updateMenuItem(itemId, updates) {
            const itemIndex = this.menuItems.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) {
                this.menuItems[itemIndex] = { ...this.menuItems[itemIndex], ...updates };
                this.renderSidebar();
                this.setActiveItem();
            }
        },

        // Refresh sidebar (useful when user role changes)
        refresh() {
            this.renderSidebar();
            this.setActiveItem();
        }
    };

    // Initialize sidebar when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for Common.js to load if available
        const initSidebar = () => {
            if (document.getElementById('sidebarNav')) {
                SidebarConfig.init();

                // Listen for route changes (for SPA-like behavior)
                window.addEventListener('popstate', () => {
                    SidebarConfig.setActiveItem();
                });
            }
        };

        if (window.Common) {
            initSidebar();
        } else {
            setTimeout(initSidebar, 100);
        }
    });

    // Export SidebarConfig for global access
    window.SidebarConfig = SidebarConfig;
</script>

<!-- Legacy Sidebar Fragment - Deprecated -->
<!-- This fragment is kept for backward compatibility -->
<!-- Use components/sidebar.html instead -->
<div th:fragment="sidebar" class="legacy-sidebar-notice">
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Deprecated:</strong> This sidebar fragment is deprecated.
        Please use <code>components/sidebar.html</code> instead.
    </div>

    <!-- Redirect to new sidebar component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>
</div>
