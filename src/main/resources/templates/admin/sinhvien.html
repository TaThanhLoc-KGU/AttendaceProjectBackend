<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sinh viên - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        /* Tùy chỉnh CSS cho trang sinh viên */
        .student-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        .face-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .face-image-item {
            position: relative;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .face-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-image-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
        }

        .upload-drop-zone {
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-drop-zone:hover {
            background: rgba(28, 102, 129, 0.05);
        }

        .upload-drop-zone.dragover {
            background: rgba(28, 102, 129, 0.1);
            border-color: var(--primary-dark);
        }

        .progress-container {
            margin-top: 1rem;
        }

        .feature-extraction-section {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .extraction-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.ready { background: var(--success-color); }
        .status-indicator.processing { background: var(--warning-color); }
        .status-indicator.empty { background: var(--gray-400); }
        .status-indicator.error { background: var(--danger-color); }

        .import-preview-table {
            max-height: 300px;
            overflow-y: auto;
        }

        .bulk-actions {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Quản lý Sinh viên</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span th:text="'Xin chào, ' + ${session.user?.hoTen ?: 'Admin'}">Xin chào, Admin</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="stats-grid">
            <div class="stats-card primary">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" id="totalStudents">0</h3>
                    <p class="stats-label">Tổng sinh viên</p>
                </div>
            </div>

            <div class="stats-card success">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" id="activeStudents">0</h3>
                    <p class="stats-label">Đang hoạt động</p>
                </div>
            </div>

            <div class="stats-card info">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" id="studentsWithPhoto">0</h3>
                    <p class="stats-label">Có ảnh đại diện</p>
                </div>
            </div>

            <div class="stats-card warning">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" id="studentsWithEmbedding">0</h3>
                    <p class="stats-label">Đã có đặc trưng</p>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="form-group">
                    <label for="searchInput">Tìm kiếm</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="searchInput" class="form-control"
                               placeholder="Tìm theo mã SV, họ tên, email...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label for="classFilter">Lớp</label>
                    <select id="classFilter" class="form-select">
                        <option value="">Tất cả lớp</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="statusFilter">Trạng thái</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="inactive">Không hoạt động</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="SinhVienManager.showAddModal()">
                        <i class="fas fa-plus me-2"></i>Thêm sinh viên
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
            <div class="d-flex align-items-center gap-3">
                <span id="selectedCount">0 sinh viên đã chọn</span>
                <button class="btn btn-sm btn-outline-danger" onclick="sinhVienManager.bulkDelete()">
                    <i class="fas fa-trash me-1"></i>Xóa
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="sinhVienManager.bulkActivate()">
                    <i class="fas fa-check me-1"></i>Kích hoạt
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="sinhVienManager.bulkDeactivate()">
                    <i class="fas fa-times me-1"></i>Vô hiệu hóa
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="sinhVienManager.clearSelection()">
                    <i class="fas fa-times me-1"></i>Bỏ chọn
                </button>
            </div>
        </div>

        <!-- Students Table -->
        <div class="admin-table-wrapper">
            <div class="admin-table-header">
                <h3 class="admin-table-title">Danh sách Sinh viên</h3>
                <div class="table-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="sinhVienManager.refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="sinhVienManager.showImportModal()">
                        <i class="fas fa-file-import me-1"></i>Import Excel
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button"
                                data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>Xuất dữ liệu
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="sinhVienManager.exportData('excel')">
                                <i class="fas fa-file-excel me-2"></i>Excel
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="sinhVienManager.exportData('pdf')">
                                <i class="fas fa-file-pdf me-2"></i>PDF
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="sinhVienManager.downloadTemplate()">
                                <i class="fas fa-download me-2"></i>Tải mẫu Excel
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll" onclick="sinhVienManager.toggleSelectAll()">
                        </th>
                        <th width="60">Ảnh</th>
                        <th width="100">Mã SV</th>
                        <th>Họ tên</th>
                        <th width="100">Lớp</th>
                        <th>Email</th>
                        <th width="80">Giới tính</th>
                        <th width="100">Trạng thái</th>
                        <th width="120">Nhận diện</th>
                        <th width="150">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody id="sinhvienTableBody">
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">Đang tải dữ liệu...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="admin-pagination-wrapper">
                <div class="pagination-info">
                    <span id="paginationInfo">Hiển thị 0 - 0 của 0 sinh viên</span>
                </div>
                <nav>
                    <ul class="pagination admin-pagination" id="pagination">
                        <!-- Pagination will be generated by JS -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Student Modal -->
<div class="modal fade admin-modal" id="sinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm sinh viên mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sinhvienForm">
                    <div class="row">
                        <!-- Left Column - Basic Info -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Thông tin cơ bản</h6>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="maSv">Mã sinh viên <span class="text-danger">*</span></label>
                                    <input type="text" id="maSv" name="maSv" class="form-control" required>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="hoTen">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" id="hoTen" name="hoTen" class="form-control" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" name="email" class="form-control">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="gioiTinh">Giới tính</label>
                                    <select id="gioiTinh" name="gioiTinh" class="form-select">
                                        <option value="">Chọn giới tính</option>
                                        <option value="NAM">Nam</option>
                                        <option value="NU">Nữ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="ngaySinh">Ngày sinh</label>
                                    <input type="date" id="ngaySinh" name="ngaySinh" class="form-control">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="maLop">Lớp <span class="text-danger">*</span></label>
                                    <select id="maLop" name="maLop" class="form-select" required>
                                        <option value="">Chọn lớp</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Profile Image Upload -->
                            <div class="form-group">
                                <label>Ảnh đại diện</label>
                                <div class="upload-drop-zone" id="profileUploadZone">
                                    <div id="profilePreview" class="d-none">
                                        <img id="profileImg" src="" alt="Profile" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="SinhVienManager.removeProfileImage()">
                                            <i class="fas fa-trash"></i> Xóa ảnh
                                        </button>
                                    </div>
                                    <div id="profileUploadPlaceholder">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                        <p class="mb-0">Kéo thả ảnh vào đây hoặc click để chọn</p>
                                        <small class="text-muted">Hỗ trợ: JPG, PNG, WEBP (tối đa 5MB)</small>
                                    </div>
                                </div>
                                <input type="file" id="profileImageFile" accept="image/*" style="display: none;">
                            </div>
                        </div>

                        <!-- Right Column - Face Recognition -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Nhận diện khuôn mặt</h6>

                            <!-- Face Images Upload -->
                            <div class="form-group">
                                <label>Ảnh khuôn mặt (tối đa 5 ảnh)</label>
                                <div class="upload-drop-zone mb-3" id="faceUploadZone">
                                    <i class="fas fa-user-plus fa-3x text-muted mb-2"></i>
                                    <p class="mb-0">Tải lên ảnh khuôn mặt</p>
                                    <small class="text-muted">Khuyến nghị: 1 ảnh chính diện + 4 ảnh góc khác</small>
                                </div>
                                <input type="file" id="faceImageFile" accept="image/*" multiple style="display: none;">

                                <!-- Face Images Grid -->
                                <div class="face-images-grid" id="faceImagesGrid">
                                    <!-- Face images will be displayed here -->
                                </div>

                                <div class="progress-container" id="uploadProgress" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted mt-1">Đang tải lên...</small>
                                </div>
                            </div>

                            <!-- Feature Extraction Section -->
                            <div class="feature-extraction-section">
                                <div class="extraction-status" id="extractionStatus">
                                    <span class="status-indicator empty" id="statusIndicator"></span>
                                    <span id="statusText">Chưa có đặc trưng</span>
                                </div>

                                <button type="button" class="btn btn-info btn-sm" id="extractFeaturesBtn"
                                        onclick="SinhVienManager.extractFeatures()" disabled>
                                    <i class="fas fa-magic me-2"></i>Trích xuất đặc trưng
                                </button>

                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Cần có ít nhất 1 ảnh khuôn mặt để trích xuất đặc trưng
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="sinhVienManager.saveStudent()">
                    <i class="fas fa-save me-2"></i>Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Excel Modal -->
<div class="modal fade admin-modal" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import sinh viên từ Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="excel-import-area" id="importStep1">
                    <div class="text-center mb-4">
                        <i class="fas fa-file-excel text-success" style="font-size: 3rem;"></i>
                        <h6 class="mt-2">Tải lên file Excel</h6>
                        <p class="text-muted mb-3">
                            File Excel cần có các cột: <strong>maSv, hoTen, email, gioiTinh, ngaySinh, maLop</strong>
                        </p>
                    </div>

                    <div class="upload-drop-zone" id="excelUploadZone">
                        <i class="fas fa-upload fa-3x text-muted mb-2"></i>
                        <p class="mb-0">Kéo thả file Excel vào đây hoặc click để chọn</p>
                        <small class="text-muted">Hỗ trợ: .xlsx, .xls</small>
                    </div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">

                    <div class="text-center mt-3">
                        <button class="btn btn-outline-info" onclick="sinhVienManager.downloadTemplate()">
                            <i class="fas fa-download me-2"></i>Tải mẫu Excel
                        </button>
                    </div>
                </div>

                <!-- Import Preview -->
                <div id="importStep2" style="display: none;">
                    <h6>Xem trước dữ liệu (<span id="previewCount">0</span> sinh viên):</h6>
                    <div class="import-preview-table">
                        <table class="table table-sm table-bordered">
                            <thead id="importPreviewHeader"></thead>
                            <tbody id="importPreviewBody"></tbody>
                        </table>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="createAccountsCheck" checked>
                        <label class="form-check-label" for="createAccountsCheck">
                            Tự động tạo tài khoản đăng nhập (mật khẩu mặc định: mã sinh viên)
                        </label>
                    </div>
                </div>

                <!-- Import Progress -->
                <div id="importStep3" style="display: none;">
                    <h6>Đang import dữ liệu...</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="importProgressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="importStatus">Đang xử lý...</p>
                </div>

                <!-- Import Results -->
                <div id="importStep4" style="display: none;">
                    <div class="alert alert-success" id="importSuccess" style="display: none;">
                        <h6><i class="fas fa-check-circle me-2"></i>Import thành công!</h6>
                        <p class="mb-0" id="successMessage"></p>
                    </div>

                    <div class="alert alert-warning" id="importPartial" style="display: none;">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Import hoàn tất với một số lỗi</h6>
                        <p class="mb-0" id="partialMessage"></p>
                    </div>

                    <div class="alert alert-danger" id="importError" style="display: none;">
                        <h6><i class="fas fa-times-circle me-2"></i>Import thất bại</h6>
                        <div id="errorList"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-outline-secondary" id="importBackBtn"
                        onclick="sinhVienManager.importBack()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </button>
                <button type="button" class="btn btn-primary" id="confirmImportBtn"
                        onclick="sinhVienManager.confirmImport()" style="display: none;">
                    <i class="fas fa-check me-2"></i>Xác nhận Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Student Modal -->
<div class="modal fade admin-modal" id="viewSinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="editFromViewBtn" onclick="sinhVienManager.editFromView()">
                    <i class="fas fa-edit me-2"></i>Chỉnh sửa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading" style="display: none;">
    <div class="text-center">
        <div class="loading-spinner"></div>
        <p class="mt-2">Đang xử lý...</p>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/admin.js}"></script>

<!-- Student Management JavaScript -->
<script>
    class SinhVienManager {
        constructor() {
            this.API_BASE = '/api';
            this.data = {
                sinhviens: [],
                totalItems: 0,
                totalPages: 0,
                currentPage: 1,
                pageSize: 10,
                filters: {
                    search: '',
                    class: '',
                    status: ''
                },
                selectedStudents: new Set(),
                isEditMode: false,
                currentStudentId: null,
                currentViewingStudent: null,
                excelData: null,
                faceImages: []
            };
            this.init();
        }

        async init() {
            await this.loadClasses();
            await this.loadData();
            this.setupEventListeners();
            this.setupDragAndDrop();
            await this.updateStats();

            // Expose instance globally for onclick handlers
            window.sinhVienManager = this;
        }

        setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.data.filters.search = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                }, 500);
            });

            // Filter selects
            document.getElementById('classFilter').addEventListener('change', (e) => {
                this.data.filters.class = e.target.value;
                this.data.currentPage = 1;
                this.loadData();
            });

            document.getElementById('statusFilter').addEventListener('change', (e) => {
                this.data.filters.status = e.target.value;
                this.data.currentPage = 1;
                this.loadData();
            });

            // Modal events
            document.getElementById('sinhvienModal').addEventListener('hidden.bs.modal', () => {
                this.resetForm();
            });

            document.getElementById('importModal').addEventListener('hidden.bs.modal', () => {
                this.resetImportModal();
            });
        }

        setupDragAndDrop() {
            // Profile image drag and drop
            this.setupDropZone('profileUploadZone', 'profileImageFile', false);

            // Face images drag and drop
            this.setupDropZone('faceUploadZone', 'faceImageFile', true);

            // Excel file drag and drop
            this.setupDropZone('excelUploadZone', 'excelFile', false, true);
        }

        setupDropZone(zoneId, inputId, multiple = false, isExcel = false) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (multiple) {
                        this.handleMultipleFiles(files, zoneId);
                    } else {
                        input.files = files;
                        if (isExcel) {
                            this.handleExcelUpload(input);
                        } else {
                            this.handleFileUpload(input, zoneId);
                        }
                    }
                }
            });

            input.addEventListener('change', (e) => {
                if (multiple) {
                    this.handleMultipleFiles(e.target.files, zoneId);
                } else if (isExcel) {
                    this.handleExcelUpload(e.target);
                } else {
                    this.handleFileUpload(e.target, zoneId);
                }
            });
        }

        async loadClasses() {
            try {
                const response = await fetch(`${this.API_BASE}/lop`);
                if (!response.ok) throw new Error('Failed to load classes');

                const classes = await response.json();
                const classSelects = document.querySelectorAll('#classFilter, #maLop');

                classSelects.forEach(select => {
                    // Keep current option for filter
                    if (select.id === 'classFilter') {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Tất cả lớp</option>';
                        classes.forEach(cls => {
                            select.innerHTML += `<option value="${cls.maLop}">${cls.tenLop}</option>`;
                        });
                        select.value = currentValue;
                    } else {
                        select.innerHTML = '<option value="">Chọn lớp</option>';
                        classes.forEach(cls => {
                            select.innerHTML += `<option value="${cls.maLop}">${cls.tenLop}</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading classes:', error);
                this.showAlert('Không thể tải danh sách lớp', 'danger');
            }
        }

        async loadData() {
            try {
                this.showTableLoading(true);

                const params = new URLSearchParams({
                    page: this.data.currentPage - 1,
                    size: this.data.pageSize
                });

                if (this.data.filters.search) {
                    params.append('search', this.data.filters.search);
                }
                if (this.data.filters.class) {
                    params.append('class', this.data.filters.class);
                }
                if (this.data.filters.status) {
                    params.append('status', this.data.filters.status);
                }

                const response = await fetch(`${this.API_BASE}/sinhvien?${params}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const result = await response.json();

                if (result.content) {
                    this.data.sinhviens = result.content;
                    this.data.totalItems = result.totalElements;
                    this.data.totalPages = result.totalPages;
                    this.data.currentPage = result.number + 1;
                } else {
                    this.data.sinhviens = result;
                    this.data.totalItems = result.length;
                    this.data.totalPages = Math.ceil(result.length / this.data.pageSize);
                }

                this.renderTable();
                this.renderPagination();

            } catch (error) {
                console.error('Error loading data:', error);
                this.showAlert('Không thể tải dữ liệu sinh viên', 'danger');
            } finally {
                this.showTableLoading(false);
            }
        }

        renderTable() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (!tbody) return;

            if (this.data.sinhviens.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Không có dữ liệu sinh viên</p>
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = this.data.sinhviens.map(sv => `
            <tr>
                <td>
                    <input type="checkbox" value="${sv.maSv}"
                           onchange="sinhVienManager.toggleSelect('${sv.maSv}')"
                           ${this.data.selectedStudents.has(sv.maSv) ? 'checked' : ''}>
                </td>
                <td>
                    <div class="student-avatar">
                        ${sv.hinhAnh ?
                `<img src="${sv.hinhAnh}" alt="${sv.hoTen}">` :
                `<div class="photo-placeholder"><i class="fas fa-user"></i></div>`
            }
                    </div>
                </td>
                <td><strong>${sv.maSv}</strong></td>
                <td>${sv.hoTen}</td>
                <td><span class="badge bg-info">${sv.maLop || 'N/A'}</span></td>
                <td>${sv.email || 'N/A'}</td>
                <td>${this.formatGender(sv.gioiTinh)}</td>
                <td>${this.formatStatus(sv.isActive)}</td>
                <td>${this.formatRecognitionStatus(sv)}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info" onclick="sinhVienManager.viewStudent('${sv.maSv}')"
                                title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="sinhVienManager.editStudent('${sv.maSv}')"
                                title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="sinhVienManager.deleteStudent('${sv.maSv}')"
                                title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

            this.updateSelectionUI();
        }

        renderPagination() {
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');

            if (!pagination || !paginationInfo) return;

            // Update info
            const start = (this.data.currentPage - 1) * this.data.pageSize + 1;
            const end = Math.min(this.data.currentPage * this.data.pageSize, this.data.totalItems);
            paginationInfo.textContent = `Hiển thị ${start} - ${end} của ${this.data.totalItems} sinh viên`;

            // Generate pagination
            let paginationHTML = '';

            // Previous button
            paginationHTML += `
            <li class="page-item ${this.data.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="sinhVienManager.changePage(${this.data.currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, this.data.currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(this.data.totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                <li class="page-item ${i === this.data.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="sinhVienManager.changePage(${i})">${i}</a>
                </li>
            `;
            }

            // Next button
            paginationHTML += `
            <li class="page-item ${this.data.currentPage === this.data.totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="sinhVienManager.changePage(${this.data.currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

            pagination.innerHTML = paginationHTML;
        }

        async updateStats() {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/statistics`);
                if (!response.ok) throw new Error('Failed to load statistics');

                const stats = await response.json();

                document.getElementById('totalStudents').textContent = stats.totalStudents || 0;
                document.getElementById('activeStudents').textContent = stats.activeStudents || 0;
                document.getElementById('studentsWithPhoto').textContent = stats.studentsWithPhoto || 0;
                document.getElementById('studentsWithEmbedding').textContent = stats.studentsWithEmbedding || 0;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Utility methods
        formatGender(gender) {
            if (!gender) return 'N/A';
            return gender === 'NAM' ? 'Nam' : gender === 'NU' ? 'Nữ' : gender;
        }

        formatStatus(isActive) {
            if (isActive === null || isActive === undefined) {
                return '<span class="badge bg-secondary">N/A</span>';
            }
            return isActive ?
                '<span class="badge bg-success">Hoạt động</span>' :
                '<span class="badge bg-danger">Không hoạt động</span>';
        }

        formatRecognitionStatus(student) {
            const hasPhoto = student.hinhAnh && student.hinhAnh.trim() !== '';
            const hasEmbedding = student.embedding && student.embedding.trim() !== '';

            if (hasEmbedding) {
                return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Sẵn sàng</span>';
            } else if (hasPhoto) {
                return '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Chưa trích xuất</span>';
            } else {
                return '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>Chưa có ảnh</span>';
            }
        }

        showTableLoading(show) {
            const tbody = document.getElementById('sinhvienTableBody');
            if (show) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">Đang tải dữ liệu...</p>
                    </td>
                </tr>
            `;
            }
        }

        showAlert(message, type = 'info') {
            Swal.fire({
                icon: type === 'danger' ? 'error' : type,
                title: type === 'danger' ? 'Lỗi' : 'Thông báo',
                text: message,
                timer: 3000,
                showConfirmButton: false
            });
        }

        showLoading(show) {
            const loading = document.getElementById('globalLoading');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }

        // Page navigation
        changePage(page) {
            if (page < 1 || page > this.data.totalPages) return;
            this.data.currentPage = page;
            this.loadData();
        }

        // Selection methods
        toggleSelect(maSv) {
            if (this.data.selectedStudents.has(maSv)) {
                this.data.selectedStudents.delete(maSv);
            } else {
                this.data.selectedStudents.add(maSv);
            }
            this.updateSelectionUI();
        }

        toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]');

            if (selectAll.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    this.data.selectedStudents.add(cb.value);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    this.data.selectedStudents.delete(cb.value);
                });
            }
            this.updateSelectionUI();
        }

        clearSelection() {
            this.data.selectedStudents.clear();
            document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAll').checked = false;
            this.updateSelectionUI();
        }

        updateSelectionUI() {
            const count = this.data.selectedStudents.size;
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            if (count > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = `${count} sinh viên đã chọn`;
            } else {
                bulkActions.classList.remove('show');
            }
        }

        // Modal methods
        showAddModal() {
            this.data.isEditMode = false;
            this.data.currentStudentId = null;
            document.getElementById('modalTitle').textContent = 'Thêm sinh viên mới';
            document.getElementById('maSv').readOnly = false;

            const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
            modal.show();
        }

        async editStudent(maSv) {
            try {
                this.showLoading(true);

                const response = await fetch(`${this.API_BASE}/sinhvien/by-masv/${maSv}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const student = await response.json();

                this.data.isEditMode = true;
                this.data.currentStudentId = maSv;
                document.getElementById('modalTitle').textContent = 'Chỉnh sửa sinh viên';
                document.getElementById('maSv').readOnly = true;

                this.populateForm(student);
                await this.loadFaceImages(maSv);

                const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading student for edit:', error);
                this.showAlert('Không thể tải thông tin sinh viên', 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        async viewStudent(maSv) {
            try {
                this.showLoading(true);

                const response = await fetch(`${this.API_BASE}/sinhvien/by-masv/${maSv}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const student = await response.json();
                const faceImages = await this.getFaceImages(maSv);

                this.showViewModal(student, faceImages);

            } catch (error) {
                console.error('Error loading student for view:', error);
                this.showAlert('Không thể tải thông tin sinh viên', 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        populateForm(student) {
            document.getElementById('maSv').value = student.maSv || '';
            document.getElementById('hoTen').value = student.hoTen || '';
            document.getElementById('email').value = student.email || '';
            document.getElementById('gioiTinh').value = student.gioiTinh || '';
            document.getElementById('maLop').value = student.maLop || '';

            // Format date for input
            if (student.ngaySinh) {
                const date = new Date(student.ngaySinh);
                if (!isNaN(date)) {
                    document.getElementById('ngaySinh').value = date.toISOString().split('T')[0];
                }
            }

            // Show profile image if exists
            if (student.hinhAnh) {
                this.showProfilePreview(student.hinhAnh);
            }

            // Update extraction status
            this.updateExtractionStatus(student);
        }

        showViewModal(student, faceImages) {
            const modalBody = document.getElementById('viewModalBody');

            modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="mb-4">
                        ${student.hinhAnh ?
                `<img src="${student.hinhAnh}" alt="${student.hoTen}"
                                  class="img-fluid rounded" style="max-width: 250px;">` :
                `<div class="photo-placeholder d-inline-flex align-items-center justify-content-center"
                                  style="width: 250px; height: 250px; border: 2px dashed #ccc;">
                                <i class="fas fa-user fa-5x text-muted"></i>
                            </div>`
            }
                    </div>

                    <div class="recognition-status">
                        <h6>Trạng thái nhận diện</h6>
                        ${this.formatRecognitionStatus(student)}
                        <div class="mt-2">
                            <small class="text-muted">
                                Ảnh khuôn mặt: ${faceImages.length}/5
                            </small>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="info-grid">
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Mã sinh viên:</strong></div>
                            <div class="col-sm-8">${student.maSv}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Họ và tên:</strong></div>
                            <div class="col-sm-8">${student.hoTen}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Email:</strong></div>
                            <div class="col-sm-8">${student.email || 'Chưa có'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Giới tính:</strong></div>
                            <div class="col-sm-8">${this.formatGender(student.gioiTinh)}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Ngày sinh:</strong></div>
                            <div class="col-sm-8">${student.ngaySinh ? new Date(student.ngaySinh).toLocaleDateString('vi-VN') : 'Chưa có'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Lớp:</strong></div>
                            <div class="col-sm-8">${student.maLop || 'Chưa có'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><strong>Trạng thái:</strong></div>
                            <div class="col-sm-8">${this.formatStatus(student.isActive)}</div>
                        </div>
                    </div>

                    ${faceImages.length > 0 ? `
                        <div class="mt-4">
                            <h6>Ảnh khuôn mặt (${faceImages.length})</h6>
                            <div class="face-images-grid">
                                ${faceImages.map(img => `
                                    <div class="face-image-item">
                                        <img src="${img.url}" alt="Face image">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;

            // Store current student for edit button
            this.currentViewingStudent = student.maSv;

            const modal = new bootstrap.Modal(document.getElementById('viewSinhvienModal'));
            modal.show();
        }

        editFromView() {
            if (this.currentViewingStudent) {
                bootstrap.Modal.getInstance(document.getElementById('viewSinhvienModal')).hide();
                setTimeout(() => this.editStudent(this.currentViewingStudent), 300);
            }
        }

        resetForm() {
            document.getElementById('sinhvienForm').reset();
            this.hideProfilePreview();
            this.clearFaceImages();
            this.updateExtractionStatus(null);
            this.data.faceImages = [];
            this.data.isEditMode = false;
            this.data.currentStudentId = null;
        }

        // Image handling methods
        async handleFileUpload(input, zoneId) {
            const file = input.files[0];
            if (!file) return;

            if (zoneId === 'profileUploadZone') {
                await this.handleProfileImage(file);
            }
        }

        async handleMultipleFiles(files, zoneId) {
            if (zoneId === 'faceUploadZone') {
                await this.handleFaceImages(files);
            }
        }

        async handleProfileImage(file) {
            if (!this.validateImageFile(file)) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                this.showProfilePreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async handleFaceImages(files) {
            const currentCount = this.data.faceImages.length;
            const maxImages = 5;

            if (currentCount >= maxImages) {
                this.showAlert(`Đã đạt giới hạn ${maxImages} ảnh khuôn mặt`, 'warning');
                return;
            }

            const remainingSlots = maxImages - currentCount;
            const filesToProcess = Array.from(files).slice(0, remainingSlots);

            for (const file of filesToProcess) {
                if (this.validateImageFile(file)) {
                    await this.addFaceImage(file);
                }
            }

            this.updateExtractionButton();
        }

        validateImageFile(file) {
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!allowedTypes.includes(file.type)) {
                this.showAlert('Vui lòng chọn file ảnh (JPG, PNG, WEBP)', 'warning');
                return false;
            }

            if (file.size > maxSize) {
                this.showAlert('Kích thước file không được vượt quá 5MB', 'warning');
                return false;
            }

            return true;
        }

        showProfilePreview(src) {
            document.getElementById('profilePreview').classList.remove('d-none');
            document.getElementById('profileUploadPlaceholder').style.display = 'none';
            document.getElementById('profileImg').src = src;
        }

        hideProfilePreview() {
            document.getElementById('profilePreview').classList.add('d-none');
            document.getElementById('profileUploadPlaceholder').style.display = 'block';
            document.getElementById('profileImg').src = '';
            document.getElementById('profileImageFile').value = '';
        }

        removeProfileImage() {
            this.hideProfilePreview();
        }

        async addFaceImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageData = {
                    id: Date.now() + Math.random(),
                    file: file,
                    url: e.target.result,
                    filename: file.name
                };

                this.data.faceImages.push(imageData);
                this.renderFaceImages();
            };
            reader.readAsDataURL(file);
        }

        renderFaceImages() {
            const grid = document.getElementById('faceImagesGrid');

            grid.innerHTML = this.data.faceImages.map(img => `
            <div class="face-image-item" data-id="${img.id}">
                <img src="${img.url}" alt="${img.filename}">
                                                <button type="button" class="face-image-delete"
                        onclick="sinhVienManager.removeFaceImage('${img.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
        }

        removeFaceImage(imageId) {
            this.data.faceImages = this.data.faceImages.filter(img => img.id != imageId);
            this.renderFaceImages();
            this.updateExtractionButton();
        }

        clearFaceImages() {
            this.data.faceImages = [];
            document.getElementById('faceImagesGrid').innerHTML = '';
            this.updateExtractionButton();
        }

        async loadFaceImages(maSv) {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}/face-images`);
                if (response.ok) {
                    const images = await response.json();
                    this.data.faceImages = images.map(img => ({
                        id: img.id,
                        url: img.url,
                        filename: img.filename,
                        uploaded: true
                    }));
                    this.renderFaceImages();
                    this.updateExtractionButton();
                }
            } catch (error) {
                console.error('Error loading face images:', error);
            }
        }

        async getFaceImages(maSv) {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}/face-images`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error getting face images:', error);
            }
            return [];
        }

        // Feature extraction methods
        updateExtractionStatus(student) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (!student) {
                indicator.className = 'status-indicator empty';
                text.textContent = 'Chưa có đặc trưng';
                return;
            }

            const hasEmbedding = student.embedding && student.embedding.trim() !== '';

            if (hasEmbedding) {
                indicator.className = 'status-indicator ready';
                text.textContent = 'Đã có đặc trưng';
            } else {
                indicator.className = 'status-indicator empty';
                text.textContent = 'Chưa có đặc trưng';
            }

            this.updateExtractionButton();
        }

        updateExtractionButton() {
            const btn = document.getElementById('extractFeaturesBtn');
            const hasImages = this.data.faceImages.length > 0;

            btn.disabled = !hasImages;

            if (hasImages) {
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>Trích xuất đặc trưng';
                btn.className = 'btn btn-info btn-sm';
            } else {
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>Cần ảnh khuôn mặt';
                btn.className = 'btn btn-secondary btn-sm';
            }
        }

        async extractFeatures() {
            if (!this.data.currentStudentId) {
                this.showAlert('Vui lòng lưu sinh viên trước khi trích xuất đặc trưng', 'warning');
                return;
            }

            if (this.data.faceImages.length === 0) {
                this.showAlert('Cần có ít nhất 1 ảnh khuôn mặt để trích xuất đặc trưng', 'warning');
                return;
            }

            try {
                // Update status to processing
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                const btn = document.getElementById('extractFeaturesBtn');

                indicator.className = 'status-indicator processing';
                text.textContent = 'Đang trích xuất...';
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';

                // Call Python feature extraction service
                const response = await fetch(`${this.API_BASE}/sinhvien/${this.data.currentStudentId}/extract-features`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    throw new Error('API endpoint chưa được triển khai. Vui lòng thêm endpoint extract-features vào SinhVienController.');
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Feature extraction failed');
                }

                const result = await response.json();

                // Update status to ready
                indicator.className = 'status-indicator ready';
                text.textContent = 'Đã có đặc trưng';
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Đã hoàn thành';

                this.showAlert('Trích xuất đặc trưng thành công!', 'success');

            } catch (error) {
                console.error('Error extracting features:', error);

                // Update status to error
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                const btn = document.getElementById('extractFeaturesBtn');

                indicator.className = 'status-indicator error';
                text.textContent = 'Lỗi trích xuất';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic me-2"></i>Thử lại';

                this.showAlert('Không thể trích xuất đặc trưng: ' + error.message, 'danger');
            }
        }

        // Save student methods
        async saveStudent() {
            try {
                const formData = this.getFormData();
                if (!formData) return;

                this.showLoading(true);

                let response;
                if (this.data.isEditMode) {
                    response = await fetch(`${this.API_BASE}/sinhvien/${this.data.currentStudentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${this.API_BASE}/sinhvien`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save student');
                }

                const savedStudent = await response.json();
                this.data.currentStudentId = savedStudent.maSv;

                // Upload profile image if exists
                const profileFile = document.getElementById('profileImageFile').files[0];
                if (profileFile) {
                    await this.uploadProfileImage(savedStudent.maSv, profileFile);
                }

                // Upload face images if exists
                if (this.data.faceImages.length > 0) {
                    await this.uploadFaceImages(savedStudent.maSv);
                }

                this.showAlert(
                    this.data.isEditMode ? 'Cập nhật sinh viên thành công!' : 'Thêm sinh viên thành công!',
                    'success'
                );

                // Close modal and refresh data
                bootstrap.Modal.getInstance(document.getElementById('sinhvienModal')).hide();
                this.loadData();
                this.updateStats();

            } catch (error) {
                console.error('Error saving student:', error);
                this.showAlert('Không thể lưu thông tin sinh viên: ' + error.message, 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        getFormData() {
            const maSv = document.getElementById('maSv').value.trim();
            const hoTen = document.getElementById('hoTen').value.trim();
            const maLop = document.getElementById('maLop').value.trim();

            if (!maSv || !hoTen || !maLop) {
                this.showAlert('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
                return null;
            }

            return {
                maSv,
                hoTen,
                email: document.getElementById('email').value.trim() || null,
                gioiTinh: document.getElementById('gioiTinh').value || null,
                ngaySinh: document.getElementById('ngaySinh').value || null,
                maLop,
                isActive: true
            };
        }

        async uploadProfileImage(maSv, file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}/upload-profile-image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to upload profile image');
                }

            } catch (error) {
                console.error('Error uploading profile image:', error);
                this.showAlert('Không thể tải lên ảnh đại diện', 'warning');
            }
        }

        async uploadFaceImages(maSv) {
            try {
                for (const imageData of this.data.faceImages) {
                    if (imageData.file && !imageData.uploaded) {
                        const formData = new FormData();
                        formData.append('file', imageData.file);

                        const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}/upload-face-image`, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            console.error('Failed to upload face image:', imageData.filename);
                        }
                    }
                }
            } catch (error) {
                console.error('Error uploading face images:', error);
                this.showAlert('Một số ảnh khuôn mặt không thể tải lên', 'warning');
            }
        }

        // Delete student
        async deleteStudent(maSv) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: `Bạn có chắc chắn muốn xóa sinh viên ${maSv}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                try {
                    this.showLoading(true);

                    const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete student');
                    }

                    this.showAlert('Xóa sinh viên thành công!', 'success');
                    this.loadData();
                    this.updateStats();

                } catch (error) {
                    console.error('Error deleting student:', error);
                    this.showAlert('Không thể xóa sinh viên', 'danger');
                } finally {
                    this.showLoading(false);
                }
            }
        }

        // Bulk operations
        async bulkDelete() {
            if (this.data.selectedStudents.size === 0) {
                this.showAlert('Vui lòng chọn sinh viên để xóa', 'warning');
                return;
            }

            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: `Bạn có chắc chắn muốn xóa ${this.data.selectedStudents.size} sinh viên đã chọn?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                try {
                    this.showLoading(true);

                    const response = await fetch(`${this.API_BASE}/sinhvien/bulk-delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(Array.from(this.data.selectedStudents))
                    });

                    if (!response.ok) {
                        throw new Error('Failed to bulk delete students');
                    }

                    const result = await response.json();
                    this.showAlert(result.message, 'success');

                    this.clearSelection();
                    this.loadData();
                    this.updateStats();

                } catch (error) {
                    console.error('Error bulk deleting students:', error);
                    this.showAlert('Không thể xóa sinh viên', 'danger');
                } finally {
                    this.showLoading(false);
                }
            }
        }

        async bulkActivate() {
            await this.bulkUpdateStatus(true);
        }

        async bulkDeactivate() {
            await this.bulkUpdateStatus(false);
        }

        async bulkUpdateStatus(isActive) {
            if (this.data.selectedStudents.size === 0) {
                this.showAlert('Vui lòng chọn sinh viên để cập nhật', 'warning');
                return;
            }

            try {
                this.showLoading(true);

                const response = await fetch(`${this.API_BASE}/sinhvien/bulk-update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentIds: Array.from(this.data.selectedStudents),
                        isActive: isActive
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to bulk update status');
                }

                const result = await response.json();
                this.showAlert(result.message, 'success');

                this.clearSelection();
                this.loadData();
                this.updateStats();

            } catch (error) {
                console.error('Error bulk updating status:', error);
                this.showAlert('Không thể cập nhật trạng thái', 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        // Excel import/export methods
        showImportModal() {
            this.resetImportModal();
            const modal = new bootstrap.Modal(document.getElementById('importModal'));
            modal.show();
        }

        resetImportModal() {
            // Reset to step 1
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'none';
            document.getElementById('importStep4').style.display = 'none';

            // Reset buttons
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('importBackBtn').style.display = 'none';

            // Clear data
            this.data.excelData = null;
            document.getElementById('excelFile').value = '';
        }

        async handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                this.showAlert('Vui lòng chọn file Excel (.xlsx, .xls)', 'warning');
                return;
            }

            try {
                this.showLoading(true);

                const data = await this.parseExcelFile(file);
                this.data.excelData = data;

                this.showImportPreview(data);
                this.showImportStep(2);

            } catch (error) {
                console.error('Error parsing Excel file:', error);
                this.showAlert('Không thể đọc file Excel: ' + error.message, 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        async parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Không thể đọc file'));
                reader.readAsArrayBuffer(file);
            });
        }

        showImportPreview(data) {
            if (!data || data.length === 0) {
                this.showAlert('File Excel không có dữ liệu', 'warning');
                return;
            }

            const headers = Object.keys(data[0]);
            const preview = data.slice(0, 10); // Show first 10 rows

            // Update preview count
            document.getElementById('previewCount').textContent = data.length;

            // Generate header
            const headerHTML = headers.map(h => `<th>${h}</th>`).join('');
            document.getElementById('importPreviewHeader').innerHTML = `<tr>${headerHTML}</tr>`;

            // Generate body
            const bodyHTML = preview.map(row => {
                const cells = headers.map(h => `<td>${row[h] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            document.getElementById('importPreviewBody').innerHTML = bodyHTML;
        }

        showImportStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`importStep${i}`).style.display = 'none';
            }

            // Show current step
            document.getElementById(`importStep${step}`).style.display = 'block';

            // Update buttons
            if (step === 2) {
                document.getElementById('confirmImportBtn').style.display = 'inline-block';
                document.getElementById('importBackBtn').style.display = 'inline-block';
            } else if (step === 4) {
                document.getElementById('confirmImportBtn').style.display = 'none';
                document.getElementById('importBackBtn').style.display = 'none';
            }
        }

        importBack() {
            this.showImportStep(1);
        }

        async confirmImport() {
            if (!this.data.excelData) {
                this.showAlert('Không có dữ liệu để import', 'warning');
                return;
            }

            try {
                this.showImportStep(3);

                const createAccounts = document.getElementById('createAccountsCheck').checked;

                // Create FormData
                const formData = new FormData();
                const excelFile = document.getElementById('excelFile').files[0];
                formData.append('file', excelFile);
                formData.append('createAccounts', createAccounts);

                const response = await fetch(`${this.API_BASE}/sinhvien/import-excel`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                this.showImportResult(result);
                this.showImportStep(4);

                // Refresh data
                this.loadData();
                this.updateStats();

            } catch (error) {
                console.error('Error importing Excel:', error);
                this.showAlert('Không thể import dữ liệu: ' + error.message, 'danger');
                this.showImportStep(2);
            }
        }

        showImportResult(result) {
            // Hide all result divs
            document.getElementById('importSuccess').style.display = 'none';
            document.getElementById('importPartial').style.display = 'none';
            document.getElementById('importError').style.display = 'none';

            if (result.status === 'SUCCESS') {
                document.getElementById('importSuccess').style.display = 'block';
                document.getElementById('successMessage').textContent =
                    `Đã import thành công ${result.successCount} sinh viên.`;
            } else if (result.status === 'PARTIAL_SUCCESS') {
                document.getElementById('importPartial').style.display = 'block';
                document.getElementById('partialMessage').innerHTML =
                    `Import hoàn tất với ${result.successCount} thành công, ${result.failedCount} thất bại.<br>
                 ${result.errors ? result.errors.join('<br>') : ''}`;
            } else {
                document.getElementById('importError').style.display = 'block';
                document.getElementById('errorList').innerHTML =
                    result.errors ? result.errors.join('<br>') : 'Có lỗi xảy ra trong quá trình import.';
            }
        }

        // Export methods
        async exportData(format) {
            try {
                this.showLoading(true);

                const params = new URLSearchParams();
                if (this.data.filters.search) params.append('search', this.data.filters.search);
                if (this.data.filters.class) params.append('classFilter', this.data.filters.class);
                if (this.data.filters.status) params.append('status', this.data.filters.status);

                if (format === 'excel') {
                    const response = await fetch(`${this.API_BASE}/sinhvien/export-excel?${params}`);
                    if (!response.ok) throw new Error('Export failed');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'danh-sach-sinh-vien.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else if (format === 'pdf') {
                    // TODO: Implement PDF export
                    this.showAlert('Chức năng xuất PDF đang được phát triển', 'info');
                }

            } catch (error) {
                console.error('Error exporting data:', error);
                this.showAlert('Không thể xuất dữ liệu', 'danger');
            } finally {
                this.showLoading(false);
            }
        }

        async downloadTemplate() {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/download-template`);
                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mau-import-sinh-vien.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error downloading template:', error);
                this.showAlert('Không thể tải mẫu Excel', 'danger');
            }
        }

        // Utility methods
        refreshData() {
            this.loadData();
            this.updateStats();
            this.showAlert('Dữ liệu đã được làm mới', 'info');
        }
    }

    // Initialize manager when page loads
    let sinhVienManager;
    document.addEventListener('DOMContentLoaded', function() {
        sinhVienManager = new SinhVienManager();
    });

    // Pass current user data to sidebar if available
    window.currentUser = /*[[${session.user}]]*/ null;
</script>

<!-- Pass current user data to sidebar -->
<script th:inline="javascript">
    window.currentUser = /*[[${session.user}]]*/ null;
</script>

</body>
</html>