<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Sinh vi√™n - Face Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body class="admin-dashboard">
<div class="main-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <h4><i class="fas fa-graduation-cap me-2"></i>Face Attendance</h4>
        </div>

        <ul class="sidebar-nav">
            <li class="nav-item">
                <a href="/admin/dashboard" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/khoa" class="nav-link">
                    <i class="fas fa-university"></i>
                    <span class="nav-text">Qu·∫£n l√Ω Khoa</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/nganh" class="nav-link">
                    <i class="fas fa-sitemap"></i>
                    <span class="nav-text">Qu·∫£n l√Ω Ng√†nh</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/monhoc" class="nav-link">
                    <i class="fas fa-book"></i>
                    <span class="nav-text">Qu·∫£n l√Ω M√¥n h·ªçc</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/giangvien" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span class="nav-text">Qu·∫£n l√Ω Gi·∫£ng vi√™n</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/sinhvien" class="nav-link active">
                    <i class="fas fa-user-graduate"></i>
                    <span class="nav-text">Qu·∫£n l√Ω Sinh vi√™n</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/lop" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Qu·∫£n l√Ω L·ªõp</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/diemdanh" class="nav-link">
                    <i class="fas fa-clipboard-check"></i>
                    <span class="nav-text">ƒêi·ªÉm danh</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/admin/baocao" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">B√°o c√°o</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="header-right">
                    <div class="user-dropdown">
                        <div class="user-info" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar">
                                <span th:text="${currentUser?.username?.substring(0,1)?.toUpperCase() ?: 'A'}">A</span>
                            </div>
                            <div class="user-details">
                                <h6 th:text="${currentUser?.username ?: 'Admin'}">Admin</h6>
                                <p>Qu·∫£n tr·ªã vi√™n</p>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user"></i>H·ªì s∆°</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog"></i>C√†i ƒë·∫∑t</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i>ƒêƒÉng xu·∫•t</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title">Qu·∫£n l√Ω Sinh vi√™n</h2>
                <p class="page-subtitle">Qu·∫£n l√Ω th√¥ng tin sinh vi√™n v√† ƒëi·ªÉm danh</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stats-card primary">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="totalStudents">0</div>
                    <div class="stats-label">T·ªïng sinh vi√™n</div>
                </div>

                <div class="stats-card success">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="activeStudents">0</div>
                    <div class="stats-label">ƒêang ho·∫°t ƒë·ªông</div>
                </div>

                <div class="stats-card warning">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="studentsWithPhoto">0</div>
                    <div class="stats-label">C√≥ ·∫£nh ƒë·∫°i di·ªán</div>
                </div>

                <div class="stats-card info">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="studentsWithEmbedding">0</div>
                    <div class="stats-label">C√≥ d·ªØ li·ªáu nh·∫≠n di·ªán</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-row">
                    <div class="search-group">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" class="form-control search-input"
                               placeholder="T√¨m ki·∫øm sinh vi√™n..." id="searchInput">
                    </div>
                    <select class="form-select" id="classFilter" style="width: auto;">
                        <option value="">T·∫•t c·∫£ l·ªõp</option>
                    </select>
                    <select class="form-select" id="statusFilter" style="width: auto;">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                    <button class="btn btn-primary" onclick="SinhVienManager.showAddModal()">
                        <i class="fas fa-plus me-2"></i>Th√™m sinh vi√™n
                    </button>
                </div>
            </div>

            <!-- Students Table -->
            <div class="admin-table-wrapper">
                <div class="admin-table-header">
                    <h3 class="admin-table-title">Danh s√°ch Sinh vi√™n</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="SinhVienManager.refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="SinhVienManager.bulkImport()">
                            <i class="fas fa-file-import me-1"></i>Import Excel
                        </button>
                        <div class="export-controls">
                            <button class="btn-export" onclick="SinhVienManager.exportData('excel')">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </button>
                            <button class="btn-export" onclick="SinhVienManager.exportData('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>PDF
                            </button>
                        </div>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onclick="SinhVienManager.toggleSelectAll()">
                        </th>
                        <th>·∫¢nh</th>
                        <th>M√£ SV</th>
                        <th>H·ªç t√™n</th>
                        <th>L·ªõp</th>
                        <th>Email</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Nh·∫≠n di·ªán</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </thead>
                    <tbody id="sinhvienTableBody">
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav class="admin-pagination">
                <ul class="pagination" id="paginationControls">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
    </main>
</div>

<!-- Add/Edit Student Modal -->
<div class="modal fade admin-modal" id="sinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Th√™m sinh vi√™n m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body admin-form-body">
                <form id="sinhvienForm" class="admin-form" novalidate>
                    <!-- Row 1: M√£ SV v√† H·ªç t√™n -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maSv" class="form-label">M√£ sinh vi√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="maSv" name="maSv"
                                   placeholder="Nh·∫≠p m√£ sinh vi√™n" maxlength="20" required>
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p m√£ sinh vi√™n (t·ªëi ƒëa 20 k√Ω t·ª±)</div>
                        </div>
                        <div class="form-group">
                            <label for="hoTen" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="hoTen" name="hoTen"
                                   placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß" maxlength="100" required>
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n (t·ªëi ƒëa 100 k√Ω t·ª±)</div>
                        </div>
                    </div>

                    <!-- Row 2: Email v√† Gi·ªõi t√≠nh -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control-admin" id="email" name="email"
                                   placeholder="example@email.com">
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p email h·ª£p l·ªá</div>
                        </div>
                        <div class="form-group">
                            <label for="gioiTinh" class="form-label">Gi·ªõi t√≠nh</label>
                            <select class="form-control-admin" id="gioiTinh" name="gioiTinh">
                                <option value="NAM">Nam</option>
                                <option value="NU">N·ªØ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Ng√†y sinh v√† L·ªõp -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ngaySinh" class="form-label">Ng√†y sinh</label>
                            <input type="date" class="form-control-admin" id="ngaySinh" name="ngaySinh">
                        </div>
                        <div class="form-group">
                            <label for="lopSearch" class="form-label">L·ªõp <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control-admin" id="lopSearch"
                                       placeholder="T√¨m ki·∫øm v√† ch·ªçn l·ªõp..." autocomplete="off" required>
                                <input type="hidden" id="maLop" name="maLop">
                                <div class="dropdown-menu w-100" id="lopDropdown" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Dropdown items will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="invalid-feedback">Vui l√≤ng ch·ªçn l·ªõp</div>
                            <small class="form-text text-muted">Nh·∫≠p t√™n l·ªõp ƒë·ªÉ t√¨m ki·∫øm</small>
                        </div>
                    </div>

                    <!-- Row 4: ·∫¢nh ƒë·∫°i di·ªán -->
                    <div class="form-group">
                        <label for="hinhAnhUpload" class="form-label">·∫¢nh ƒë·∫°i di·ªán</label>
                        <div class="file-upload-area" onclick="document.getElementById('hinhAnhFile').click()">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">
                                <p class="mb-1">Nh·∫•p ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</p>
                                <small class="text-muted">ƒê·ªãnh d·∫°ng: JPG, PNG, GIF. T·ªëi ƒëa: 5MB</small>
                            </div>
                        </div>
                        <input type="file" id="hinhAnhFile" name="hinhAnhFile" accept="image/*"
                               style="display: none;" onchange="SinhVienManager.handleImageUpload(this)">
                        <input type="hidden" id="hinhAnh" name="hinhAnh">
                        <div class="mt-2" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="/placeholder.svg" alt="Preview"
                                 style="max-width: 200px; height: auto; border-radius: 8px;">
                        </div>
                    </div>

                    <!-- Row 5: Tr·∫°ng th√°i -->
                    <div class="form-group">
                        <label for="isActive" class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-control-admin" id="isActive" name="isActive">
                            <option value="true">Ho·∫°t ƒë·ªông</option>
                            <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="SinhVienManager.saveSinhVien()">
                    <span class="loading-spinner d-none">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    <span class="btn-text">L∆∞u</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Student Modal -->
<div class="modal fade admin-modal" id="viewSinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√¥ng tin sinh vi√™n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin.js}"></script>

<script>
    const SinhVienManager = {
        data: {
            sinhviens: [],
            classes: [],
            currentPage: 1,
            pageSize: 10,
            totalItems: 0,
            totalPages: 0,
            selectedIds: new Set(),
            editingId: null,
            filters: {
                search: '',
                class: '',
                status: ''
            }
        },

        async init() {
            try {
                console.log('üöÄ Initializing SinhVienManager...');

                // Load classes first
                await this.loadClasses();

                // Then load student data
                await this.loadData();

                // Setup event listeners
                this.setupEventListeners();

                console.log('‚úÖ SinhVienManager initialized successfully');
            } catch (error) {
                console.error('‚ùå Failed to initialize SinhVienManager:', error);
                this.showAlert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o trang: ' + error.message, 'danger');
            }
        },

        setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', this.debounce((e) => {
                    this.data.filters.search = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                }, 300));
            }

            // Class filter
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.addEventListener('change', (e) => {
                    this.data.filters.class = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    this.data.filters.status = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Class search functionality
            this.setupClassSearch();
        },

        setupClassSearch() {
            const lopSearch = document.getElementById('lopSearch');
            const lopDropdown = document.getElementById('lopDropdown');
            const maLopHidden = document.getElementById('maLop');

            if (!lopSearch || !lopDropdown) return;

            // Show dropdown on focus
            lopSearch.addEventListener('focus', () => {
                this.showClassDropdown();
            });

            // Filter classes on input
            lopSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                this.filterClassDropdown(searchTerm);
                this.showClassDropdown();
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!lopSearch.contains(e.target) && !lopDropdown.contains(e.target)) {
                    this.hideClassDropdown();
                }
            });
        },

        showClassDropdown() {
            const lopDropdown = document.getElementById('lopDropdown');
            lopDropdown.classList.add('show');
        },

        hideClassDropdown() {
            const lopDropdown = document.getElementById('lopDropdown');
            lopDropdown.classList.remove('show');
        },

        filterClassDropdown(searchTerm) {
            const lopDropdown = document.getElementById('lopDropdown');
            const filteredClasses = this.data.classes.filter(lop =>
                lop.tenLop.toLowerCase().includes(searchTerm) ||
                lop.maLop.toLowerCase().includes(searchTerm)
            );

            lopDropdown.innerHTML = filteredClasses.map(lop => `
                <a class="dropdown-item" href="#" onclick="SinhVienManager.selectClass('${lop.maLop}', '${lop.tenLop}')">
                    <strong>${lop.maLop}</strong> - ${lop.tenLop}
                </a>
            `).join('');

            if (filteredClasses.length === 0) {
                lopDropdown.innerHTML = '<div class="dropdown-item-text text-muted">Kh√¥ng t√¨m th·∫•y l·ªõp n√†o</div>';
            }
        },

        selectClass(maLop, tenLop) {
            document.getElementById('lopSearch').value = `${maLop} - ${tenLop}`;
            document.getElementById('maLop').value = maLop;
            this.hideClassDropdown();

            // Clear validation
            const lopSearch = document.getElementById('lopSearch');
            lopSearch.classList.remove('is-invalid');
            lopSearch.classList.add('is-valid');
        },

        async loadClasses() {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch('/api/lop', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    this.data.classes = await response.json();
                    this.populateClassOptions();
                    this.filterClassDropdown(''); // Initialize dropdown
                } else {
                    console.warn('‚ö†Ô∏è Could not load classes');
                }
            } catch (error) {
                console.error('‚ùå Error loading classes:', error);
            }
        },

        populateClassOptions() {
            const classFilter = document.getElementById('classFilter');

            const options = this.data.classes.map(lop =>
                `<option value="${lop.maLop}">${lop.tenLop}</option>`
            ).join('');

            if (classFilter) {
                classFilter.innerHTML = '<option value="">T·∫•t c·∫£ l·ªõp</option>' + options;
            }
        },

        async loadData() {
            try {
                this.showLoading(true);

                const token = localStorage.getItem('accessToken');
                const response = await fetch('/api/sinhvien?size=1000', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                let result = await response.json();
                let sinhviens = [];

                // Handle paginated response
                if (result.content) {
                    sinhviens = result.content;
                    this.data.totalItems = result.totalElements;
                    this.data.totalPages = Math.ceil(result.totalElements / this.data.pageSize);
                } else if (Array.isArray(result)) {
                    sinhviens = result;
                    this.data.totalItems = result.length;
                    this.data.totalPages = Math.ceil(result.length / this.data.pageSize);
                }

                // Apply filters
                if (this.data.filters.search) {
                    sinhviens = sinhviens.filter(sv =>
                        sv.maSv?.toLowerCase().includes(this.data.filters.search.toLowerCase()) ||
                        sv.hoTen?.toLowerCase().includes(this.data.filters.search.toLowerCase()) ||
                        (sv.email && sv.email.toLowerCase().includes(this.data.filters.search.toLowerCase()))
                    );
                }

                if (this.data.filters.class) {
                    sinhviens = sinhviens.filter(sv => sv.lop?.maLop === this.data.filters.class);
                }

                if (this.data.filters.status) {
                    const isActive = this.data.filters.status === 'active';
                    sinhviens = sinhviens.filter(sv => sv.isActive === isActive);
                }

                this.data.sinhviens = sinhviens;

                // Update totals after filtering
                this.data.totalItems = sinhviens.length;
                this.data.totalPages = Math.ceil(sinhviens.length / this.data.pageSize);

                this.updateStats();
                this.renderTable();
                this.renderPagination();

            } catch (error) {
                console.error('‚ùå Error loading student data:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu sinh vi√™n: ' + error.message, 'danger');
                this.renderError();
            } finally {
                this.showLoading(false);
            }
        },

        updateStats() {
            const total = this.data.sinhviens.length;
            const active = this.data.sinhviens.filter(sv => sv.isActive).length;
            const withPhoto = this.data.sinhviens.filter(sv => sv.hinhAnh).length;
            const withEmbedding = this.data.sinhviens.filter(sv => sv.embedding).length;

            this.animateNumber(document.getElementById('totalStudents'), total);
            this.animateNumber(document.getElementById('activeStudents'), active);
            this.animateNumber(document.getElementById('studentsWithPhoto'), withPhoto);
            this.animateNumber(document.getElementById('studentsWithEmbedding'), withEmbedding);
        },

        renderTable() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (!tbody) return;

            if (this.data.sinhviens.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu sinh vi√™n</p>
                    </td>
                </tr>
            `;
                return;
            }

            const startIndex = (this.data.currentPage - 1) * this.data.pageSize;
            const endIndex = startIndex + this.data.pageSize;
            const pageData = this.data.sinhviens.slice(startIndex, endIndex);

            tbody.innerHTML = pageData.map(sv => `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input"
                           onchange="SinhVienManager.toggleSelect('${sv.maSv}')"
                           ${this.data.selectedIds.has(sv.maSv) ? 'checked' : ''}>
                </td>
                <td>
                    <div class="student-avatar">
                        ${sv.hinhAnh ?
                `<img src="${sv.hinhAnh}" alt="${sv.hoTen}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${sv.hoTen?.charAt(0)?.toUpperCase() || 'N'}</div>`
            }
                    </div>
                </td>
                <td><strong>${sv.maSv || 'N/A'}</strong></td>
                <td>${sv.hoTen || 'N/A'}</td>
                <td>
                    <span class="badge badge-info">
                        ${this.getClassName(sv.lop)}
                    </span>
                </td>
                <td>${sv.email || '-'}</td>
                <td>
                    <i class="fas fa-${sv.gioiTinh === 'NAM' ? 'mars text-primary' : 'venus text-danger'}"></i>
                    ${sv.gioiTinh === 'NAM' ? 'Nam' : 'N·ªØ'}
                </td>
                <td>
                    <span class="status-badge ${sv.isActive ? 'status-active' : 'status-inactive'}">
                        ${sv.isActive ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${sv.embedding ? 'status-completed' : 'status-pending'}">
                        ${sv.embedding ? 'C√≥' : 'Ch∆∞a c√≥'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="SinhVienManager.viewSinhVien('${sv.maSv}')"
                                title="Xem chi ti·∫øt">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" onclick="SinhVienManager.editSinhVien('${sv.maSv}')"
                                title="Ch·ªânh s·ª≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="SinhVienManager.deleteSinhVien('${sv.maSv}', '${sv.hoTen}')"
                                title="X√≥a">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        },

        getClassName(lop) {
            if (lop && lop.tenLop) {
                return lop.tenLop;
            }
            return 'N/A';
        },

        renderPagination() {
            const pagination = document.getElementById('paginationControls');
            if (!pagination || this.data.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `
            <li class="page-item ${this.data.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, this.data.currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(this.data.totalPages, startPage + maxVisible - 1);

            for (let i = startPage; i <= endPage; i++) {
                html += `
                <li class="page-item ${i === this.data.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${i})">${i}</a>
                </li>
            `;
            }

            // Next button
            html += `
            <li class="page-item ${this.data.currentPage === this.data.totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

            pagination.innerHTML = html;
        },

        goToPage(page) {
            if (page >= 1 && page <= this.data.totalPages && page !== this.data.currentPage) {
                this.data.currentPage = page;
                this.renderTable();
                this.renderPagination();
            }
        },

        showAddModal() {
            this.data.editingId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m sinh vi√™n m·ªõi';
            document.getElementById('sinhvienForm').reset();
            document.getElementById('maSv').disabled = false;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('lopSearch').value = '';
            document.getElementById('maLop').value = '';
            this.clearValidation();

            const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
            modal.show();
        },

        async editSinhVien(maSv) {
            try {
                const student = this.data.sinhviens.find(sv => sv.maSv === maSv);
                if (!student) {
                    this.showAlert('Kh√¥ng t√¨m th·∫•y sinh vi√™n', 'danger');
                    return;
                }

                this.data.editingId = maSv;
                document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a sinh vi√™n';
                document.getElementById('maSv').disabled = true;

                // Populate form
                document.getElementById('maSv').value = student.maSv || '';
                document.getElementById('hoTen').value = student.hoTen || '';
                document.getElementById('email').value = student.email || '';
                document.getElementById('ngaySinh').value = student.ngaySinh || '';
                document.getElementById('gioiTinh').value = student.gioiTinh || 'NAM';
                document.getElementById('isActive').value = student.isActive ? 'true' : 'false';

                // Set class
                if (student.lop) {
                    document.getElementById('lopSearch').value = `${student.lop.maLop} - ${student.lop.tenLop}`;
                    document.getElementById('maLop').value = student.lop.maLop;
                }

                // Handle image
                if (student.hinhAnh) {
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('previewImg').src = student.hinhAnh;
                    document.getElementById('hinhAnh').value = student.hinhAnh;
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }

                this.clearValidation();

                const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
                modal.show();
            } catch (error) {
                console.error('‚ùå Error editing student:', error);
                this.showAlert('Kh√¥ng th·ªÉ ch·ªânh s·ª≠a sinh vi√™n: ' + error.message, 'danger');
            }
        },

        async viewSinhVien(maSv) {
            try {
                const student = this.data.sinhviens.find(sv => sv.maSv === maSv);
                if (!student) {
                    this.showAlert('Kh√¥ng t√¨m th·∫•y sinh vi√™n', 'danger');
                    return;
                }

                const modalBody = document.getElementById('viewModalBody');
                modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        ${student.hinhAnh ?
                    `<img src="${student.hinhAnh}" alt="${student.hoTen}" class="img-fluid rounded-circle mb-3" style="max-width: 200px;">` :
                    `<div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 200px; height: 200px; font-size: 4rem; color: white;">${student.hoTen?.charAt(0)?.toUpperCase() || 'N'}</div>`
                }
                        <h5>${student.hoTen}</h5>
                        <p class="text-muted">${student.maSv}</p>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-borderless">
                            <tr><td><strong>Email:</strong></td><td>${student.email || 'Ch∆∞a c√≥'}</td></tr>
                            <tr><td><strong>Ng√†y sinh:</strong></td><td>${student.ngaySinh || 'Ch∆∞a c√≥'}</td></tr>
                            <tr><td><strong>Gi·ªõi t√≠nh:</strong></td><td>${student.gioiTinh === 'NAM' ? 'Nam' : 'N·ªØ'}</td></tr>
                            <tr><td><strong>L·ªõp:</strong></td><td>${this.getClassName(student.lop)}</td></tr>
                            <tr><td><strong>Tr·∫°ng th√°i:</strong></td><td>
                                <span class="status-badge ${student.isActive ? 'status-active' : 'status-inactive'}">
                                    ${student.isActive ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                                </span>
                            </td></tr>
                            <tr><td><strong>Nh·∫≠n di·ªán:</strong></td><td>
                                <span class="status-badge ${student.embedding ? 'status-completed' : 'status-pending'}">
                                    ${student.embedding ? 'ƒê√£ c√≥ d·ªØ li·ªáu' : 'Ch∆∞a c√≥ d·ªØ li·ªáu'}
                                </span>
                            </td></tr>
                        </table>
                    </div>
                </div>
            `;

                const modal = new bootstrap.Modal(document.getElementById('viewSinhvienModal'));
                modal.show();
            } catch (error) {
                console.error('‚ùå Error viewing student:', error);
                this.showAlert('Kh√¥ng th·ªÉ xem th√¥ng tin sinh vi√™n: ' + error.message, 'danger');
            }
        },

        async saveSinhVien() {
            try {
                const form = document.getElementById('sinhvienForm');
                if (!this.validateForm(form)) {
                    return;
                }

                this.setSaveButtonLoading(true);

                const formData = new FormData(form);
                const data = {};

                // Convert FormData to object
                for (let [key, value] of formData.entries()) {
                    if (key === 'isActive') {
                        data[key] = value === 'true';
                    } else if (value !== '') {
                        data[key] = value;
                    }
                }

                // Ensure required fields are not empty
                if (!data.maSv || data.maSv.trim() === '') {
                    this.showAlert('M√£ sinh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'danger');
                    this.setSaveButtonLoading(false);
                    return;
                }

                if (!data.hoTen || data.hoTen.trim() === '') {
                    this.showAlert('H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'danger');
                    this.setSaveButtonLoading(false);
                    return;
                }

                if (!data.maLop || data.maLop.trim() === '') {
                    this.showAlert('Vui l√≤ng ch·ªçn l·ªõp', 'danger');
                    this.setSaveButtonLoading(false);
                    return;
                }

                const token = localStorage.getItem('accessToken');
                const url = this.data.editingId ? `/api/sinhvien/${this.data.editingId}` : '/api/sinhvien';
                const method = this.data.editingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                this.showAlert(
                    this.data.editingId ? 'C·∫≠p nh·∫≠t sinh vi√™n th√†nh c√¥ng!' : 'Th√™m sinh vi√™n th√†nh c√¥ng!',
                    'success'
                );

                // Close modal and refresh data
                const modal = bootstrap.Modal.getInstance(document.getElementById('sinhvienModal'));
                modal.hide();

                await this.loadData();

            } catch (error) {
                console.error('‚ùå Error saving student:', error);
                this.showAlert('Kh√¥ng th·ªÉ l∆∞u sinh vi√™n: ' + error.message, 'danger');
            } finally {
                this.setSaveButtonLoading(false);
            }
        },

        async deleteSinhVien(maSv, hoTen) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n "${hoTen}" (${maSv})?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`/api/sinhvien/${maSv}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                this.showAlert('X√≥a sinh vi√™n th√†nh c√¥ng!', 'success');
                await this.loadData();

            } catch (error) {
                console.error('‚ùå Error deleting student:', error);
                this.showAlert('Kh√¥ng th·ªÉ x√≥a sinh vi√™n: ' + error.message, 'danger');
            }
        },

        validateForm(form) {
            let isValid = true;
            const requiredFields = ['maSv', 'hoTen', 'maLop'];

            requiredFields.forEach(fieldName => {
                let field;
                if (fieldName === 'maLop') {
                    field = form.querySelector('#lopSearch');
                } else {
                    field = form.querySelector(`[name="${fieldName}"]`);
                }

                if (field) {
                    const value = fieldName === 'maLop' ?
                        document.getElementById('maLop').value.trim() :
                        field.value.trim();

                    if (!value) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    }
                }
            });

            // Email validation
            const emailField = form.querySelector('[name="email"]');
            if (emailField && emailField.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailField.value)) {
                    emailField.classList.add('is-invalid');
                    isValid = false;
                } else {
                    emailField.classList.remove('is-invalid');
                    emailField.classList.add('is-valid');
                }
            }

            return isValid;
        },

        clearValidation() {
            const form = document.getElementById('sinhvienForm');
            form.querySelectorAll('.is-invalid, .is-valid').forEach(field => {
                field.classList.remove('is-invalid', 'is-valid');
            });
        },

        handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                this.showAlert('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'danger');
                input.value = '';
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showAlert('Vui l√≤ng ch·ªçn file ·∫£nh', 'danger');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                const hinhAnhField = document.getElementById('hinhAnh');

                previewImg.src = e.target.result;
                hinhAnhField.value = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        },

        toggleSelect(maSv) {
            if (this.data.selectedIds.has(maSv)) {
                this.data.selectedIds.delete(maSv);
            } else {
                this.data.selectedIds.add(maSv);
            }
            this.updateSelectAllCheckbox();
        },

        toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const isChecked = selectAllCheckbox.checked;

            if (isChecked) {
                this.data.sinhviens.forEach(sv => this.data.selectedIds.add(sv.maSv));
            } else {
                this.data.selectedIds.clear();
            }

            // Update individual checkboxes
            document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        },

        updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const totalVisibleItems = document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]').length;
            const selectedVisibleItems = document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]:checked').length;

            selectAllCheckbox.checked = totalVisibleItems > 0 && selectedVisibleItems === totalVisibleItems;
            selectAllCheckbox.indeterminate = selectedVisibleItems > 0 && selectedVisibleItems < totalVisibleItems;
        },

        setSaveButtonLoading(loading) {
            const button = document.querySelector('#sinhvienModal .btn-primary');
            const spinner = button.querySelector('.loading-spinner');
            const text = button.querySelector('.btn-text');

            if (loading) {
                spinner.classList.remove('d-none');
                text.textContent = 'ƒêang l∆∞u...';
                button.disabled = true;
            } else {
                spinner.classList.add('d-none');
                text.textContent = 'L∆∞u';
                button.disabled = false;
            }
        },

        showLoading(show) {
            const tbody = document.getElementById('sinhvienTableBody');
            if (show && tbody) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </td>
                </tr>
            `;
            }
        },

        renderError() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (tbody) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="SinhVienManager.loadData()">
                            <i class="fas fa-redo me-1"></i>Th·ª≠ l·∫°i
                        </button>
                    </td>
                </tr>
            `;
            }
        },

        refreshData() {
            this.data.currentPage = 1;
            this.data.selectedIds.clear();
            this.loadData();
        },

        bulkImport() {
            this.showAlert('Ch·ª©c nƒÉng import Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...', 'info');
        },

        exportData(format) {
            const selectedCount = this.data.selectedIds.size;
            const message = selectedCount > 0 ?
                `ƒêang xu·∫•t ${selectedCount} sinh vi√™n ƒë√£ ch·ªçn...` :
                `ƒêang xu·∫•t t·∫•t c·∫£ ${this.data.totalItems} sinh vi√™n...`;

            this.showAlert(message, 'info');
            // Implement export functionality
        },

        animateNumber(element, targetValue) {
            if (!element) return;

            const currentValue = parseInt(element.textContent) || 0;
            const increment = (targetValue - currentValue) / 20;
            let current = currentValue;

            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= targetValue) ||
                    (increment < 0 && current <= targetValue)) {
                    current = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current);
            }, 50);
        },

        showAlert(message, type = 'info') {
            let container = document.getElementById('alertContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'alertContainer';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }

            const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${this.getAlertIcon(type)} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

            container.insertAdjacentHTML('beforeend', alertHtml);

            setTimeout(() => {
                const alerts = container.querySelectorAll('.alert');
                if (alerts.length > 0) {
                    alerts[0].remove();
                }
            }, 5000);
        },

        getAlertIcon(type) {
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        SinhVienManager.init();
    });

    // Global logout function
    function logout() {
        localStorage.clear();
        window.location.href = '/?message=logout_success';
    }

    // Global sidebar toggle function
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    }
</script>
</body>
</html>