<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sinh viên - Face Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body class="admin-dashboard">
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="page-title">Quản lý Sinh viên</h1>
                </div>
                <div class="header-right">
                    <div class="user-dropdown">
                        <div class="user-info" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar">
                                <span th:text="${currentUser?.username?.substring(0,1)?.toUpperCase() ?: 'A'}">A</span>
                            </div>
                            <div class="user-details">
                                <h6 th:text="${currentUser?.username ?: 'Admin'}">Admin</h6>
                                <p>Quản trị viên</p>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user"></i>Hồ sơ</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog"></i>Cài đặt</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i>Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title">Quản lý Sinh viên</h2>
                <p class="page-subtitle">Quản lý thông tin sinh viên và điểm danh</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stats-card primary">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="totalStudents">0</div>
                    <div class="stats-label">Tổng sinh viên</div>
                </div>

                <div class="stats-card success">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="activeStudents">0</div>
                    <div class="stats-label">Đang hoạt động</div>
                </div>

                <div class="stats-card warning">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="studentsWithPhoto">0</div>
                    <div class="stats-label">Có ảnh đại diện</div>
                </div>

                <div class="stats-card info">
                    <div class="stats-header">
                        <div class="stats-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                    </div>
                    <div class="stats-number" id="studentsWithEmbedding">0</div>
                    <div class="stats-label">Có dữ liệu nhận diện</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-row">
                    <div class="search-group">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" class="form-control search-input"
                               placeholder="Tìm kiếm sinh viên..." id="searchInput">
                    </div>
                    <select class="form-select" id="classFilter" style="width: auto;">
                        <option value="">Tất cả lớp</option>
                    </select>
                    <select class="form-select" id="statusFilter" style="width: auto;">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="inactive">Không hoạt động</option>
                    </select>
                    <button class="btn btn-primary" onclick="SinhVienManager.showAddModal()">
                        <i class="fas fa-plus me-2"></i>Thêm sinh viên
                    </button>
                </div>
            </div>

            <!-- Students Table -->
            <div class="admin-table-wrapper">
                <div class="admin-table-header">
                    <h3 class="admin-table-title">Danh sách Sinh viên</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="SinhVienManager.refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Làm mới
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="SinhVienManager.bulkImport()">
                            <i class="fas fa-file-import me-1"></i>Import Excel
                        </button>
                        <div class="export-controls">
                            <button class="btn-export" onclick="SinhVienManager.exportData('excel')">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </button>
                            <button class="btn-export" onclick="SinhVienManager.exportData('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>PDF
                            </button>
                        </div>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onclick="SinhVienManager.toggleSelectAll()">
                        </th>
                        <th>Ảnh</th>
                        <th>Mã SV</th>
                        <th>Họ tên</th>
                        <th>Lớp</th>
                        <th>Email</th>
                        <th>Giới tính</th>
                        <th>Trạng thái</th>
                        <th>Nhận diện</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody id="sinhvienTableBody">
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">Đang tải dữ liệu...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav class="admin-pagination">
                <ul class="pagination" id="paginationControls">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
    </main>
</div>

<!-- Add/Edit Student Modal -->
<div class="modal fade admin-modal" id="sinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm sinh viên mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body admin-form-body">
                <form id="sinhvienForm" class="admin-form" novalidate>
                    <!-- Row 1: Mã SV và Họ tên -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maSv" class="form-label">Mã sinh viên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="maSv" name="maSv"
                                   placeholder="Nhập mã sinh viên" maxlength="20" required>
                            <div class="invalid-feedback">Vui lòng nhập mã sinh viên (tối đa 20 ký tự)</div>
                        </div>
                        <div class="form-group">
                            <label for="hoTen" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="hoTen" name="hoTen"
                                   placeholder="Nhập họ và tên đầy đủ" maxlength="100" required>
                            <div class="invalid-feedback">Vui lòng nhập họ và tên (tối đa 100 ký tự)</div>
                        </div>
                    </div>

                    <!-- Row 2: Email và Giới tính -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control-admin" id="email" name="email"
                                   placeholder="example@email.com">
                            <div class="invalid-feedback">Vui lòng nhập email hợp lệ</div>
                        </div>
                        <div class="form-group">
                            <label for="gioiTinh" class="form-label">Giới tính</label>
                            <select class="form-control-admin" id="gioiTinh" name="gioiTinh">
                                <option value="NAM">Nam</option>
                                <option value="NU">Nữ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Ngày sinh và Lớp -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ngaySinh" class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control-admin" id="ngaySinh" name="ngaySinh">
                        </div>
                        <div class="form-group">
                            <label for="lopSearch" class="form-label">Lớp <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control-admin" id="lopSearch"
                                       placeholder="Tìm kiếm và chọn lớp..." autocomplete="off" required>
                                <input type="hidden" id="maLop" name="maLop">
                                <div class="dropdown-menu w-100" id="lopDropdown" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Dropdown items will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="invalid-feedback">Vui lòng chọn lớp</div>
                            <small class="form-text text-muted">Nhập tên lớp để tìm kiếm</small>
                        </div>
                    </div>

                    <!-- Row 4: Ảnh đại diện -->
                    <div class="form-group">
                        <label for="hinhAnhUpload" class="form-label">Ảnh đại diện</label>
                        <div class="file-upload-area" onclick="document.getElementById('hinhAnhFile').click()">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">
                                <p class="mb-1">Nhấp để chọn ảnh hoặc kéo thả vào đây</p>
                                <small class="text-muted">Định dạng: JPG, PNG, GIF. Tối đa: 5MB</small>
                            </div>
                        </div>
                        <input type="file" id="hinhAnhFile" name="hinhAnhFile" accept="image/*"
                               style="display: none;" onchange="SinhVienManager.handleImageUpload(this)">
                        <input type="hidden" id="hinhAnh" name="hinhAnh">
                        <div class="mt-2" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="/placeholder.svg" alt="Preview"
                                 style="max-width: 200px; height: auto; border-radius: 8px;">
                        </div>
                    </div>

                    <!-- Row 5: Trạng thái -->
                    <div class="form-group">
                        <label for="isActive" class="form-label">Trạng thái</label>
                        <select class="form-control-admin" id="isActive" name="isActive">
                            <option value="true">Hoạt động</option>
                            <option value="false">Không hoạt động</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="SinhVienManager.saveSinhVien()">
                    <span class="loading-spinner d-none">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    <span class="btn-text">Lưu</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Student Modal -->
<div class="modal fade admin-modal" id="viewSinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thông tin sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/admin.js}"></script>

<!-- Pass current user data to sidebar -->
<script th:inline="javascript">
    window.currentUserData = /*[[${currentUser}]]*/ null;
</script>

<script>
    const SinhVienManager = {
        data: {
            sinhviens: [],
            classes: [],
            currentPage: 1,
            pageSize: 10,
            totalItems: 0,
            totalPages: 0,
            selectedIds: new Set(),
            editingId: null,
            filters: {
                search: '',
                class: '',
                status: ''
            }
        },

        async init() {
            try {
                console.log('🚀 Initializing SinhVienManager...');

                // Load classes first
                await this.loadClasses();

                // Then load student data
                await this.loadData();

                // Setup event listeners
                this.setupEventListeners();

                console.log('✅ SinhVienManager initialized successfully');
            } catch (error) {
                console.error('❌ Failed to initialize SinhVienManager:', error);
                this.showAlert('Không thể khởi tạo trang: ' + error.message, 'danger');
            }
        },

        setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', this.debounce((e) => {
                    this.data.filters.search = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                }, 300));
            }

            // Class filter
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.addEventListener('change', (e) => {
                    this.data.filters.class = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    this.data.filters.status = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Class search functionality
            this.setupClassSearch();
        },

        setupClassSearch() {
            const lopSearch = document.getElementById('lopSearch');
            const lopDropdown = document.getElementById('lopDropdown');
            const maLopHidden = document.getElementById('maLop');

            if (!lopSearch || !lopDropdown) return;

            // Show dropdown on focus
            lopSearch.addEventListener('focus', () => {
                this.showClassDropdown();
            });

            // Filter classes on input
            lopSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                this.filterClassDropdown(searchTerm);
                this.showClassDropdown();
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!lopSearch.contains(e.target) && !lopDropdown.contains(e.target)) {
                    this.hideClassDropdown();
                }
            });
        },

        showClassDropdown() {
            const lopDropdown = document.getElementById('lopDropdown');
            lopDropdown.classList.add('show');
        },

        hideClassDropdown() {
            const lopDropdown = document.getElementById('lopDropdown');
            lopDropdown.classList.remove('show');
        },

        filterClassDropdown(searchTerm) {
            const lopDropdown = document.getElementById('lopDropdown');
            const filteredClasses = this.data.classes.filter(lop =>
                lop.tenLop.toLowerCase().includes(searchTerm) ||
                lop.maLop.toLowerCase().includes(searchTerm)
            );

            lopDropdown.innerHTML = filteredClasses.map(lop => `
                <a class="dropdown-item" href="#" onclick="SinhVienManager.selectClass('${lop.maLop}', '${lop.tenLop}')">
                    <strong>${lop.maLop}</strong> - ${lop.tenLop}
                </a>
            `).join('');

            if (filteredClasses.length === 0) {
                lopDropdown.innerHTML = '<div class="dropdown-item-text text-muted">Không tìm thấy lớp nào</div>';
            }
        },

        selectClass(maLop, tenLop) {
            document.getElementById('lopSearch').value = `${maLop} - ${tenLop}`;
            document.getElementById('maLop').value = maLop;
            this.hideClassDropdown();

            // Clear validation
            const lopSearch = document.getElementById('lopSearch');
            lopSearch.classList.remove('is-invalid');
            lopSearch.classList.add('is-valid');
        },

        async loadClasses() {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch('/api/lop', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    this.data.classes = await response.json();
                    this.populateClassOptions();
                    this.filterClassDropdown(''); // Initialize dropdown
                } else {
                    console.warn('⚠️ Could not load classes');
                }
            } catch (error) {
                console.error('❌ Error loading classes:', error);
            }
        },

        populateClassOptions() {
            const classFilter = document.getElementById('classFilter');
            if (classFilter && this.data.classes.length > 0) {
                const options = this.data.classes.map(lop =>
                    `<option value="${lop.maLop}">${lop.maLop} - ${lop.tenLop}</option>`
                ).join('');
                classFilter.innerHTML = '<option value="">Tất cả lớp</option>' + options;
            }
        },

        async loadData() {
            try {
                this.showLoading(true);

                // Mock data for now - replace with actual API call
                const mockData = this.generateMockData();
                this.data.sinhviens = mockData.sinhviens;
                this.data.totalItems = mockData.total;
                this.data.totalPages = Math.ceil(mockData.total / this.data.pageSize);

                this.applyFilters();
                this.renderTable();
                this.renderPagination();
                this.updateStats();

            } catch (error) {
                console.error('❌ Error loading data:', error);
                this.showAlert('Không thể tải dữ liệu: ' + error.message, 'danger');
                this.renderError();
            } finally {
                this.showLoading(false);
            }
        },

        generateMockData() {
            const mockSinhViens = [];
            const classes = ['CNTT01', 'CNTT02', 'KTPM01', 'KTPM02', 'KHMT01'];
            const firstNames = ['Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Huỳnh', 'Phan', 'Vũ', 'Võ', 'Đặng'];
            const lastNames = ['Văn An', 'Thị Bình', 'Minh Cường', 'Thị Dung', 'Văn Em', 'Thị Phương', 'Minh Giang', 'Thị Hoa'];

            for (let i = 1; i <= 50; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const classCode = classes[Math.floor(Math.random() * classes.length)];

                mockSinhViens.push({
                    maSv: `SV${String(i).padStart(6, '0')}`,
                    hoTen: `${firstName} ${lastName}`,
                    email: `sv${String(i).padStart(6, '0')}@student.edu.vn`,
                    gioiTinh: Math.random() > 0.5 ? 'NAM' : 'NU',
                    ngaySinh: new Date(1998 + Math.floor(Math.random() * 5), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1),
                    maLop: classCode,
                    tenLop: `Lớp ${classCode}`,
                    hinhAnh: Math.random() > 0.3 ? '/placeholder.svg?height=50&width=50' : null,
                    isActive: Math.random() > 0.1,
                    hasEmbedding: Math.random() > 0.4,
                    createdAt: new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1)
                });
            }

            return {
                sinhviens: mockSinhViens,
                total: mockSinhViens.length
            };
        },

        applyFilters() {
            let filtered = [...this.data.sinhviens];

            // Search filter
            if (this.data.filters.search) {
                const searchTerm = this.data.filters.search.toLowerCase();
                filtered = filtered.filter(sv =>
                    sv.maSv.toLowerCase().includes(searchTerm) ||
                    sv.hoTen.toLowerCase().includes(searchTerm) ||
                    sv.email.toLowerCase().includes(searchTerm)
                );
            }

            // Class filter
            if (this.data.filters.class) {
                filtered = filtered.filter(sv => sv.maLop === this.data.filters.class);
            }

            // Status filter
            if (this.data.filters.status) {
                const isActive = this.data.filters.status === 'active';
                filtered = filtered.filter(sv => sv.isActive === isActive);
            }

            this.data.filteredSinhviens = filtered;
            this.data.totalItems = filtered.length;
            this.data.totalPages = Math.ceil(filtered.length / this.data.pageSize);
        },

        renderTable() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (!tbody) return;

            const startIndex = (this.data.currentPage - 1) * this.data.pageSize;
            const endIndex = startIndex + this.data.pageSize;
            const pageData = (this.data.filteredSinhviens || this.data.sinhviens).slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không có dữ liệu sinh viên</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageData.map(sv => `
                <tr>
                    <td>
                        <input type="checkbox" value="${sv.maSv}"
                               onchange="SinhVienManager.toggleSelect('${sv.maSv}')">
                    </td>
                    <td>
                        <div class="student-avatar">
                            ${sv.hinhAnh ?
                `<img src="${sv.hinhAnh}" alt="${sv.hoTen}" class="avatar-img">` :
                `<div class="avatar-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>`
            }
                        </div>
                    </td>
                    <td><strong>${sv.maSv}</strong></td>
                    <td>${sv.hoTen}</td>
                    <td>
                        <span class="class-badge">${sv.maLop}</span>
                    </td>
                    <td>${sv.email || '<span class="text-muted">Chưa có</span>'}</td>
                    <td>
                        <span class="gender-badge ${sv.gioiTinh.toLowerCase()}">
                            <i class="fas fa-${sv.gioiTinh === 'NAM' ? 'mars' : 'venus'}"></i>
                            ${sv.gioiTinh === 'NAM' ? 'Nam' : 'Nữ'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${sv.isActive ? 'status-active' : 'status-inactive'}">
                            ${sv.isActive ? 'Hoạt động' : 'Không hoạt động'}
                        </span>
                    </td>
                    <td>
                        <span class="embedding-badge ${sv.hasEmbedding ? 'has-embedding' : 'no-embedding'}">
                            <i class="fas fa-${sv.hasEmbedding ? 'check-circle' : 'times-circle'}"></i>
                            ${sv.hasEmbedding ? 'Có' : 'Chưa có'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="SinhVienManager.viewSinhVien('${sv.maSv}')"
                                    title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="SinhVienManager.editSinhVien('${sv.maSv}')"
                                    title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-camera" onclick="SinhVienManager.manageFaceData('${sv.maSv}')"
                                    title="Quản lý dữ liệu khuôn mặt">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="SinhVienManager.deleteSinhVien('${sv.maSv}', '${sv.hoTen}')"
                                    title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        },

        renderPagination() {
            const pagination = document.getElementById('paginationControls');
            if (!pagination || this.data.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `
                <li class="page-item ${this.data.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, this.data.currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(this.data.totalPages, startPage + maxVisible - 1);

            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === this.data.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${this.data.currentPage === this.data.totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = html;
        },

        updateStats() {
            const sinhviens = this.data.filteredSinhviens || this.data.sinhviens;
            const total = sinhviens.length;
            const active = sinhviens.filter(sv => sv.isActive).length;
            const withPhoto = sinhviens.filter(sv => sv.hinhAnh).length;
            const withEmbedding = sinhviens.filter(sv => sv.hasEmbedding).length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('studentsWithPhoto').textContent = withPhoto;
            document.getElementById('studentsWithEmbedding').textContent = withEmbedding;
        },

        goToPage(page) {
            if (page >= 1 && page <= this.data.totalPages && page !== this.data.currentPage) {
                this.data.currentPage = page;
                this.renderTable();
                this.renderPagination();
            }
        },

        toggleSelect(maSv) {
            if (this.data.selectedIds.has(maSv)) {
                this.data.selectedIds.delete(maSv);
            } else {
                this.data.selectedIds.add(maSv);
            }
            this.updateSelectAllCheckbox();
        },

        toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]');

            if (selectAll.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    this.data.selectedIds.add(cb.value);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    this.data.selectedIds.delete(cb.value);
                });
            }
        },

        updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#sinhvienTableBody input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

            selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        },

        showAddModal() {
            this.data.editingId = null;
            document.getElementById('modalTitle').textContent = 'Thêm sinh viên mới';
            document.getElementById('sinhvienForm').reset();
            document.getElementById('maSv').disabled = false;
            document.getElementById('maLop').value = '';
            document.getElementById('lopSearch').value = '';
            this.hideImagePreview();
            this.clearValidation();

            const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
            modal.show();
        },

        editSinhVien(maSv) {
            const sinhvien = this.data.sinhviens.find(sv => sv.maSv === maSv);
            if (!sinhvien) return;

            this.data.editingId = maSv;
            document.getElementById('modalTitle').textContent = 'Chỉnh sửa sinh viên';

            // Fill form
            document.getElementById('maSv').value = sinhvien.maSv;
            document.getElementById('hoTen').value = sinhvien.hoTen;
            document.getElementById('email').value = sinhvien.email || '';
            document.getElementById('gioiTinh').value = sinhvien.gioiTinh;
            document.getElementById('ngaySinh').value = sinhvien.ngaySinh ? sinhvien.ngaySinh.toISOString().split('T')[0] : '';
            document.getElementById('maLop').value = sinhvien.maLop;
            document.getElementById('lopSearch').value = `${sinhvien.maLop} - ${sinhvien.tenLop}`;
            document.getElementById('isActive').value = sinhvien.isActive.toString();

            // Show image if exists
            if (sinhvien.hinhAnh) {
                this.showImagePreview(sinhvien.hinhAnh);
            } else {
                this.hideImagePreview();
            }

            // Disable mã SV when editing
            document.getElementById('maSv').disabled = true;

            this.clearValidation();

            const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
            modal.show();
        },

        viewSinhVien(maSv) {
            const sinhvien = this.data.sinhviens.find(sv => sv.maSv === maSv);
            if (!sinhvien) return;

            const modalBody = document.getElementById('viewModalBody');
            modalBody.innerHTML = `
                <div class="student-detail-view">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="student-photo-large">
                                ${sinhvien.hinhAnh ?
                `<img src="${sinhvien.hinhAnh}" alt="${sinhvien.hoTen}" class="img-fluid rounded">` :
                `<div class="photo-placeholder">
                                        <i class="fas fa-user fa-4x"></i>
                                        <p class="mt-2">Chưa có ảnh</p>
                                    </div>`
            }
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="student-info">
                                <h4>${sinhvien.hoTen}</h4>
                                <p class="text-muted mb-3">${sinhvien.maSv}</p>

                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Email:</label>
                                        <span>${sinhvien.email || 'Chưa có'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Giới tính:</label>
                                        <span>${sinhvien.gioiTinh === 'NAM' ? 'Nam' : 'Nữ'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Ngày sinh:</label>
                                        <span>${sinhvien.ngaySinh ? this.formatDate(sinhvien.ngaySinh) : 'Chưa có'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Lớp:</label>
                                        <span>${sinhvien.maLop} - ${sinhvien.tenLop}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Trạng thái:</label>
                                        <span class="status-badge ${sinhvien.isActive ? 'status-active' : 'status-inactive'}">
                                            ${sinhvien.isActive ? 'Hoạt động' : 'Không hoạt động'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <label>Dữ liệu nhận diện:</label>
                                        <span class="embedding-badge ${sinhvien.hasEmbedding ? 'has-embedding' : 'no-embedding'}">
                                            ${sinhvien.hasEmbedding ? 'Đã có' : 'Chưa có'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('viewSinhvienModal'));
            modal.show();
        },

        deleteSinhVien(maSv, hoTen) {
            if (confirm(`Bạn có chắc chắn muốn xóa sinh viên "${hoTen}" (${maSv})?`)) {
                // TODO: Implement delete API call
                this.showAlert('Xóa sinh viên thành công!', 'success');
                this.loadData();
            }
        },

        manageFaceData(maSv) {
            this.showAlert('Chức năng quản lý dữ liệu khuôn mặt đang được phát triển...', 'info');
        },

        async saveSinhVien() {
            const form = document.getElementById('sinhvienForm');
            if (!this.validateForm(form)) return;

            try {
                this.setButtonLoading(true);

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Convert boolean values
                data.isActive = data.isActive === 'true';

                console.log('Saving student data:', data);

                // TODO: Implement API call
                const isEdit = this.data.editingId !== null;
                this.showAlert(`${isEdit ? 'Cập nhật' : 'Thêm'} sinh viên thành công!`, 'success');

                bootstrap.Modal.getInstance(document.getElementById('sinhvienModal')).hide();
                await this.loadData();

            } catch (error) {
                console.error('❌ Error saving student:', error);
                this.showAlert('Không thể lưu sinh viên: ' + error.message, 'danger');
            } finally {
                this.setButtonLoading(false);
            }
        },

        validateForm(form) {
            let isValid = true;
            this.clearValidation();

            // Validate required fields
            const requiredFields = ['maSv', 'hoTen', 'maLop'];
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (!field.value.trim()) {
                    this.showFieldError(field, `${field.labels[0].textContent.replace(' *', '')} không được để trống`);
                    isValid = false;
                }
            });

            // Validate email if provided
            const emailField = document.getElementById('email');
            if (emailField.value && !this.isValidEmail(emailField.value)) {
                this.showFieldError(emailField, 'Email không hợp lệ');
                isValid = false;
            }

            return isValid;
        },

        handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showAlert('Vui lòng chọn file ảnh hợp lệ', 'warning');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                this.showAlert('Kích thước ảnh không được vượt quá 5MB', 'warning');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                this.showImagePreview(e.target.result);
                document.getElementById('hinhAnh').value = e.target.result;
            };
            reader.readAsDataURL(file);
        },

        showImagePreview(src) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            img.src = src;
            preview.style.display = 'block';
        },

        hideImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.style.display = 'none';
            document.getElementById('hinhAnh').value = '';
        },

        refreshData() {
            this.data.currentPage = 1;
            this.data.filters = { search: '', class: '', status: '' };
            this.data.selectedIds.clear();

            // Reset filter inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('classFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('selectAll').checked = false;

            this.loadData();
        },

        bulkImport() {
            this.showAlert('Chức năng import Excel đang được phát triển...', 'info');
        },

        exportData(format) {
            this.showAlert(`Đang xuất dữ liệu ${format.toUpperCase()}...`, 'info');
        },

        // Utility methods
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        },

        formatDate(date) {
            return new Date(date).toLocaleDateString('vi-VN');
        },

        showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        },

        showLoading(show) {
            const tbody = document.getElementById('sinhvienTableBody');
            if (show && tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">Đang tải dữ liệu...</p>
                        </td>
                    </tr>
                `;
            }
        },

        renderError() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <p class="text-danger">Có lỗi xảy ra khi tải dữ liệu</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="SinhVienManager.loadData()">
                                <i class="fas fa-redo me-1"></i>Thử lại
                            </button>
                        </td>
                    </tr>
                `;
            }
        },

        setButtonLoading(loading) {
            const button = document.querySelector('#sinhvienModal .btn-primary');
            const spinner = button.querySelector('.loading-spinner');
            const text = button.querySelector('.btn-text');

            button.disabled = loading;
            spinner.classList.toggle('d-none', !loading);
            text.textContent = loading ? 'Đang lưu...' : 'Lưu';
        },

        showFieldError(field, message) {
            field.classList.add('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = message;
            }
        },

        clearFieldError(field) {
            field.classList.remove('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = '';
            }
        },

        clearValidation() {
            const form = document.getElementById('sinhvienForm');
            form.querySelectorAll('.is-invalid, .is-valid').forEach(field => {
                field.classList.remove('is-invalid', 'is-valid');
            });

            form.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.textContent = '';
            });
        }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        SinhVienManager.init();
    });

    // Global logout function
    function logout() {
        if (window.SidebarManager) {
            SidebarManager.logout();
        } else {
            localStorage.clear();
            window.location.href = '/?message=logout_success';
        }
    }
</script>

<style>
    /* Additional styles for student management */
    .student-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        color: #6c757d;
        font-size: 1.2rem;
    }

    .class-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .gender-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .gender-badge.nam {
        background: #e3f2fd;
        color: #1976d2;
    }

    .gender-badge.nu {
        background: #fce4ec;
        color: #c2185b;
    }

    .embedding-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .embedding-badge.has-embedding {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .embedding-badge.no-embedding {
        background: #fff3e0;
        color: #f57c00;
    }

    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload-area:hover {
        border-color: #007bff;
        background: #f8f9ff;
    }

    .file-upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .student-detail-view .student-photo-large {
        max-width: 200px;
        margin: 0 auto;
    }

    .student-detail-view .photo-placeholder {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 2rem;
        color: #6c757d;
    }

    .student-detail-view .info-grid {
        display: grid;
        gap: 1rem;
    }

    .student-detail-view .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }

    .student-detail-view .info-item label {
        font-weight: 600;
        color: #495057;
        margin: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>
</body>
</html>
