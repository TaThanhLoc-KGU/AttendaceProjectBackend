<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Sinh vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <style>
        .student-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
        }
        .avatar-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .embedding-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .has-embedding {
            background: #d1f2eb;
            color: #00875a;
        }
        .no-embedding {
            background: #fdebf7;
            color: #e74c3c;
        }
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .face-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .face-image-slot {
            position: relative;
            aspect-ratio: 1;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .face-image-slot:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .face-image-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .face-image-slot .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .excel-import-area {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .progress-bar-custom {
            height: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .face-management-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .extraction-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
        }
        .extraction-status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-processing {
            background: #cce7ff;
            color: #0066cc;
        }
        .status-completed {
            background: #d1f2eb;
            color: #00875a;
        }
        .status-error {
            background: #fdebf7;
            color: #e74c3c;
        }
    </style>
</head>
<body>
<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <!-- Sidebar content will be loaded by sidebar.js -->
</nav>

<!-- Main Content -->
<div class="main-content">
    <main class="admin-content">
        <!-- Header -->
        <div class="admin-header">
            <div class="admin-title">
                <h1><i class="fas fa-user-graduate me-3"></i>Qu·∫£n l√Ω Sinh vi√™n</h1>
                <p class="admin-subtitle">Qu·∫£n l√Ω th√¥ng tin sinh vi√™n v√† d·ªØ li·ªáu nh·∫≠n di·ªán khu√¥n m·∫∑t</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="admin-stats">
            <div class="stats-card primary">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stats-number" id="totalStudents">0</div>
                <div class="stats-label">T·ªïng sinh vi√™n</div>
            </div>

            <div class="stats-card success">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
                <div class="stats-number" id="activeStudents">0</div>
                <div class="stats-label">ƒêang ho·∫°t ƒë·ªông</div>
            </div>

            <div class="stats-card warning">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="stats-number" id="studentsWithPhoto">0</div>
                <div class="stats-label">C√≥ ·∫£nh ƒë·∫°i di·ªán</div>
            </div>

            <div class="stats-card info">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                </div>
                <div class="stats-number" id="studentsWithEmbedding">0</div>
                <div class="stats-label">C√≥ d·ªØ li·ªáu nh·∫≠n di·ªán</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="search-group">
                    <i class="search-icon fas fa-search"></i>
                    <input type="text" class="form-control search-input"
                           placeholder="T√¨m ki·∫øm theo m√£ SV, t√™n, email..." id="searchInput">
                </div>
                <select class="form-select" id="classFilter" style="width: auto;">
                    <option value="">T·∫•t c·∫£ l·ªõp</option>
                </select>
                <select class="form-select" id="statusFilter" style="width: auto;">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                    <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                </select>
                <button class="btn btn-primary" onclick="SinhVienManager.showAddModal()">
                    <i class="fas fa-plus me-2"></i>Th√™m sinh vi√™n
                </button>
            </div>
        </div>

        <!-- Students Table -->
        <div class="admin-table-wrapper">
            <div class="admin-table-header">
                <h3 class="admin-table-title">Danh s√°ch Sinh vi√™n</h3>
                <div class="table-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="SinhVienManager.refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="SinhVienManager.showImportModal()">
                        <i class="fas fa-file-import me-1"></i>Import Excel
                    </button>
                    <div class="export-controls">
                        <button class="btn-export" onclick="SinhVienManager.exportData('excel')">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                        <button class="btn-export" onclick="SinhVienManager.exportData('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                    </div>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" onclick="SinhVienManager.toggleSelectAll()">
                    </th>
                    <th>·∫¢nh</th>
                    <th>M√£ SV</th>
                    <th>H·ªç t√™n</th>
                    <th>L·ªõp</th>
                    <th>Email</th>
                    <th>Gi·ªõi t√≠nh</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Nh·∫≠n di·ªán</th>
                    <th>Thao t√°c</th>
                </tr>
                </thead>
                <tbody id="sinhvienTableBody">
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav class="admin-pagination">
            <ul class="pagination" id="paginationControls">
                <!-- Pagination will be generated by JavaScript -->
            </ul>
        </nav>
</div>
</main>

<!-- Add/Edit Student Modal -->
<div class="modal fade admin-modal" id="sinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Th√™m sinh vi√™n m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sinhvienForm" novalidate>
                    <!-- Row 1: M√£ SV v√† H·ªç t√™n -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maSv" class="form-label">M√£ sinh vi√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="maSv" name="maSv" required maxlength="20">
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p m√£ sinh vi√™n</div>
                        </div>
                        <div class="form-group">
                            <label for="hoTen" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-admin" id="hoTen" name="hoTen" required maxlength="100">
                            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n</div>
                        </div>
                    </div>

                    <!-- Row 2: Email v√† Gi·ªõi t√≠nh -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control-admin" id="email" name="email">
                            <div class="invalid-feedback">Email kh√¥ng h·ª£p l·ªá</div>
                        </div>
                        <div class="form-group">
                            <label for="gioiTinh" class="form-label">Gi·ªõi t√≠nh</label>
                            <select class="form-control-admin" id="gioiTinh" name="gioiTinh">
                                <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                <option value="NAM">Nam</option>
                                <option value="NU">N·ªØ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Ng√†y sinh v√† L·ªõp -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ngaySinh" class="form-label">Ng√†y sinh</label>
                            <input type="date" class="form-control-admin" id="ngaySinh" name="ngaySinh">
                        </div>
                        <div class="form-group">
                            <label for="lopSearch" class="form-label">L·ªõp <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control-admin" id="lopSearch"
                                       placeholder="T√¨m ki·∫øm v√† ch·ªçn l·ªõp..." autocomplete="off" required>
                                <input type="hidden" id="maLop" name="maLop">
                                <div class="dropdown-menu w-100" id="lopDropdown" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Dropdown items will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="invalid-feedback">Vui l√≤ng ch·ªçn l·ªõp</div>
                        </div>
                    </div>

                    <!-- Row 4: ·∫¢nh ƒë·∫°i di·ªán -->
                    <div class="form-group">
                        <label for="hinhAnhUpload" class="form-label">·∫¢nh ƒë·∫°i di·ªán</label>
                        <div class="file-upload-area" onclick="document.getElementById('hinhAnhFile').click()"
                             ondrop="SinhVienManager.handleDrop(event)"
                             ondragover="SinhVienManager.handleDragOver(event)"
                             ondragleave="SinhVienManager.handleDragLeave(event)">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">
                                <p class="mb-1">Nh·∫•p ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</p>
                                <small class="text-muted">ƒê·ªãnh d·∫°ng: JPG, PNG, GIF. T·ªëi ƒëa: 5MB</small>
                            </div>
                        </div>
                        <input type="file" id="hinhAnhFile" name="hinhAnhFile" accept="image/*"
                               style="display: none;" onchange="SinhVienManager.handleImageUpload(this)">
                        <input type="hidden" id="hinhAnh" name="hinhAnh">
                        <div class="mt-2" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="" alt="Preview"
                                 style="max-width: 200px; height: auto; border-radius: 8px;">
                        </div>
                    </div>

                    <!-- Row 5: Tr·∫°ng th√°i -->
                    <div class="form-group">
                        <label for="isActive" class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-control-admin" id="isActive" name="isActive">
                            <option value="true">Ho·∫°t ƒë·ªông</option>
                            <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="SinhVienManager.saveSinhVien()">
                        <span class="loading-spinner d-none">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    <span class="btn-text">L∆∞u</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Face Management Modal -->
<div class="modal fade admin-modal" id="faceManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Qu·∫£n l√Ω d·ªØ li·ªáu khu√¥n m·∫∑t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="faceManagementContent">
                    <div class="student-info mb-4">
                        <h6>Th√¥ng tin sinh vi√™n</h6>
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-3" id="faceStudentAvatar">
                                <div class="avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1" id="faceStudentName">T√™n sinh vi√™n</h6>
                                <p class="text-muted mb-0" id="faceStudentId">M√£ sinh vi√™n</p>
                            </div>
                        </div>
                    </div>

                    <div class="face-management-section">
                        <h6 class="mb-3">
                            <i class="fas fa-images me-2"></i>·∫¢nh khu√¥n m·∫∑t (C·∫ßn 5 ·∫£nh ƒë·ªÉ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng)
                        </h6>

                        <div class="face-images-grid" id="faceImagesGrid">
                            <!-- Face image slots will be generated by JavaScript -->
                        </div>

                        <input type="file" id="faceImageInput" accept="image/*" style="display: none;"
                               onchange="SinhVienManager.handleFaceImageUpload(this)" multiple>

                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" onclick="document.getElementById('faceImageInput').click()">
                                <i class="fas fa-plus me-2"></i>Th√™m ·∫£nh khu√¥n m·∫∑t
                            </button>
                        </div>
                    </div>

                    <div class="face-management-section">
                        <h6 class="mb-3">
                            <i class="fas fa-brain me-2"></i>Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng
                        </h6>

                        <div class="extraction-controls">
                            <button class="btn btn-success" id="extractFeaturesBtn"
                                    onclick="SinhVienManager.extractFeatures()" disabled>
                                <i class="fas fa-cogs me-2"></i>Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng
                            </button>

                            <div class="extraction-status status-pending" id="extractionStatus">
                                <i class="fas fa-clock me-2"></i>Ch∆∞a tr√≠ch xu·∫•t
                            </div>
                        </div>

                        <div class="progress-bar-custom" id="extractionProgress" style="display: none;">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>

                        <div class="mt-3" id="extractionResults" style="display: none;">
                            <h6>K·∫øt qu·∫£ tr√≠ch xu·∫•t:</h6>
                            <div class="alert alert-info">
                                <strong>Th√†nh c√¥ng!</strong> ƒê√£ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng t·ª´ <span id="extractedCount">0</span> ·∫£nh.
                                <br>D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Excel Modal -->
<div class="modal fade admin-modal" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import sinh vi√™n t·ª´ Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="excel-import-area">
                    <div class="mb-3">
                        <i class="fas fa-file-excel text-success" style="font-size: 3rem;"></i>
                        <h6 class="mt-2">T·∫£i l√™n file Excel</h6>
                        <p class="text-muted mb-3">
                            File Excel c·∫ßn c√≥ c√°c c·ªôt sau:<br>
                            <strong>maSv, hoTen, email, gioiTinh, ngaySinh, maLop</strong>
                        </p>
                    </div>

                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;"
                           onchange="SinhVienManager.handleExcelUpload(this)">

                    <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-upload me-2"></i>Ch·ªçn file Excel
                    </button>

                    <div class="mt-3">
                        <a href="/templates/student-import-template.xlsx" class="btn btn-outline-info">
                            <i class="fas fa-download me-2"></i>T·∫£i m·∫´u Excel
                        </a>
                    </div>
                </div>

                <div id="importPreview" style="display: none;">
                    <h6>Xem tr∆∞·ªõc d·ªØ li·ªáu:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead id="importPreviewHeader"></thead>
                            <tbody id="importPreviewBody"></tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createAccountsCheck" checked>
                            <label class="form-check-label" for="createAccountsCheck">
                                T·ª± ƒë·ªông t·∫°o t√†i kho·∫£n ƒëƒÉng nh·∫≠p (m·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: m√£ sinh vi√™n)
                            </label>
                        </div>
                    </div>
                </div>

                <div id="importProgress" style="display: none;">
                    <h6>ƒêang import d·ªØ li·ªáu...</h6>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="importProgressFill" style="width: 0%;"></div>
                    </div>
                    <p class="mt-2" id="importStatus">ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmImportBtn"
                        onclick="SinhVienManager.confirmImport()" style="display: none;">
                    <i class="fas fa-check me-2"></i>X√°c nh·∫≠n Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Student Modal -->
<div class="modal fade admin-modal" id="viewSinhvienModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√¥ng tin sinh vi√™n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/admin.js}"></script>

<!-- Pass current user data to sidebar -->
<script th:inline="javascript">
    window.currentUserData = /*[[${currentUser}]]*/ null;
</script>

<script>
    const SinhVienManager = {
        data: {
            sinhviens: [],
            classes: [],
            currentPage: 1,
            pageSize: 10,
            totalItems: 0,
            totalPages: 0,
            selectedIds: new Set(),
            editingId: null,
            currentStudentId: null,
            faceImages: [],
            importData: null,
            filters: {
                search: '',
                class: '',
                status: ''
            }
        },

        API_BASE: '/api/admin',

        async init() {
            try {
                console.log('üöÄ Initializing SinhVienManager...');
                await this.loadClasses();
                await this.loadData();
                this.setupEventListeners();
                console.log('‚úÖ SinhVienManager initialized successfully');
            } catch (error) {
                console.error('‚ùå Failed to initialize SinhVienManager:', error);
                this.showAlert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o trang: ' + error.message, 'danger');
            }
        },

        setupEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', this.debounce((e) => {
                    this.data.filters.search = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                }, 300));
            }

            // Class filter
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.addEventListener('change', (e) => {
                    this.data.filters.class = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    this.data.filters.status = e.target.value;
                    this.data.currentPage = 1;
                    this.loadData();
                });
            }

            // Class search dropdown
            const lopSearch = document.getElementById('lopSearch');
            if (lopSearch) {
                lopSearch.addEventListener('input', this.debounce((e) => {
                    this.filterClasses(e.target.value);
                }, 200));

                lopSearch.addEventListener('focus', () => {
                    this.showClassDropdown();
                });

                lopSearch.addEventListener('blur', () => {
                    setTimeout(() => this.hideClassDropdown(), 200);
                });
            }
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        async loadClasses() {
            try {
                const response = await fetch(`${this.API_BASE}/lop`);
                if (!response.ok) throw new Error('Failed to load classes');

                this.data.classes = await response.json();
                this.populateClassFilter();
                this.populateClassDropdown();
            } catch (error) {
                console.error('Error loading classes:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch l·ªõp', 'warning');
            }
        },

        populateClassFilter() {
            const classFilter = document.getElementById('classFilter');
            if (!classFilter) return;

            classFilter.innerHTML = '<option value="">T·∫•t c·∫£ l·ªõp</option>';
            this.data.classes.forEach(lop => {
                const option = document.createElement('option');
                option.value = lop.maLop;
                option.textContent = `${lop.tenLop} (${lop.maLop})`;
                classFilter.appendChild(option);
            });
        },

        populateClassDropdown() {
            const dropdown = document.getElementById('lopDropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';
            this.data.classes.forEach(lop => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                        <strong>${lop.tenLop}</strong><br>
                        <small class="text-muted">${lop.maLop} - ${lop.tenNganh}</small>
                    `;
                item.onclick = () => this.selectClass(lop);
                dropdown.appendChild(item);
            });
        },

        filterClasses(searchTerm) {
            const dropdown = document.getElementById('lopDropdown');
            if (!dropdown) return;

            const filteredClasses = this.data.classes.filter(lop =>
                lop.tenLop.toLowerCase().includes(searchTerm.toLowerCase()) ||
                lop.maLop.toLowerCase().includes(searchTerm.toLowerCase())
            );

            dropdown.innerHTML = '';
            filteredClasses.forEach(lop => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                        <strong>${lop.tenLop}</strong><br>
                        <small class="text-muted">${lop.maLop} - ${lop.tenNganh}</small>
                    `;
                item.onclick = () => this.selectClass(lop);
                dropdown.appendChild(item);
            });

            if (filteredClasses.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item-text text-muted">Kh√¥ng t√¨m th·∫•y l·ªõp n√†o</div>';
            }
        },

        selectClass(lop) {
            document.getElementById('lopSearch').value = lop.tenLop;
            document.getElementById('maLop').value = lop.maLop;
            this.hideClassDropdown();
        },

        showClassDropdown() {
            const dropdown = document.getElementById('lopDropdown');
            if (dropdown) {
                dropdown.classList.add('show');
            }
        },

        hideClassDropdown() {
            const dropdown = document.getElementById('lopDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        },

        async loadData() {
            try {
                this.showTableLoading(true);

                const params = new URLSearchParams({
                    page: this.data.currentPage - 1,
                    size: this.data.pageSize
                });

                if (this.data.filters.search) {
                    params.append('search', this.data.filters.search);
                }
                if (this.data.filters.class) {
                    params.append('class', this.data.filters.class);
                }
                if (this.data.filters.status) {
                    params.append('status', this.data.filters.status);
                }

                const response = await fetch(`${this.API_BASE}/sinhvien?${params}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const result = await response.json();

                if (result.content) {
                    this.data.sinhviens = result.content;
                    this.data.totalItems = result.totalElements;
                    this.data.totalPages = result.totalPages;
                    this.data.currentPage = result.number + 1;
                } else {
                    this.data.sinhviens = result;
                    this.data.totalItems = result.length;
                    this.data.totalPages = Math.ceil(result.length / this.data.pageSize);
                }

                this.renderTable();
                this.renderPagination();
                this.updateStats();

            } catch (error) {
                console.error('Error loading data:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu sinh vi√™n', 'danger');
            } finally {
                this.showTableLoading(false);
            }
        },

        renderTable() {
            const tbody = document.getElementById('sinhvienTableBody');
            if (!tbody) return;

            if (this.data.sinhviens.length === 0) {
                tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu sinh vi√™n</p>
                            </td>
                        </tr>
                    `;
                return;
            }

            tbody.innerHTML = this.data.sinhviens.map(sv => `
                    <tr>
                        <td>
                            <input type="checkbox" value="${sv.maSv}"
                                   onchange="SinhVienManager.toggleSelect('${sv.maSv}')">
                        </td>
                        <td>
                            <div class="student-avatar">
                                ${sv.hinhAnh ?
                `<img src="${sv.hinhAnh}" alt="${sv.hoTen}" class="student-avatar">` :
                `<div class="student-avatar avatar-placeholder">
                                        ${sv.hoTen.charAt(0).toUpperCase()}
                                    </div>`
            }
                            </div>
                        </td>
                        <td><strong>${sv.maSv}</strong></td>
                        <td>${sv.hoTen}</td>
                        <td>
                            <div>
                                <strong>${sv.tenLop}</strong><br>
                                <small class="text-muted">${sv.maLop}</small>
                            </div>
                        </td>
                        <td>${sv.email || '<span class="text-muted">Ch∆∞a c√≥</span>'}</td>
                        <td>
                            ${sv.gioiTinh === 'NAM' ?
                '<i class="fas fa-mars text-primary"></i> Nam' :
                sv.gioiTinh === 'NU' ?
                    '<i class="fas fa-venus text-danger"></i> N·ªØ' :
                    '<span class="text-muted">Ch∆∞a x√°c ƒë·ªãnh</span>'
            }
                        </td>
                        <td>
                            <span class="badge ${sv.isActive ? 'bg-success' : 'bg-secondary'}">
                                ${sv.isActive ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                            </span>
                        </td>
                        <td>
                            <span class="embedding-badge ${sv.hasEmbedding ? 'has-embedding' : 'no-embedding'}">
                                <i class="fas fa-${sv.hasEmbedding ? 'check-circle' : 'times-circle'}"></i>
                                ${sv.hasEmbedding ? 'C√≥' : 'Ch∆∞a c√≥'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-info" onclick="SinhVienManager.viewSinhVien('${sv.maSv}')"
                                        title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="SinhVienManager.editSinhVien('${sv.maSv}')"
                                        title="Ch·ªânh s·ª≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="SinhVienManager.manageFaceData('${sv.maSv}')"
                                        title="Qu·∫£n l√Ω d·ªØ li·ªáu khu√¥n m·∫∑t">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="SinhVienManager.deleteSinhVien('${sv.maSv}', '${sv.hoTen}')"
                                        title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        },

        renderPagination() {
            const pagination = document.getElementById('paginationControls');
            if (!pagination || this.data.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `
                    <li class="page-item ${this.data.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, this.data.currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(this.data.totalPages, startPage + maxVisible - 1);

            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                        <li class="page-item ${i === this.data.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${i})">${i}</a>
                        </li>
                    `;
            }

            // Next button
            html += `
                    <li class="page-item ${this.data.currentPage === this.data.totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="SinhVienManager.goToPage(${this.data.currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;

            pagination.innerHTML = html;
        },

        updateStats() {
            const total = this.data.totalItems;
            const active = this.data.sinhviens.filter(sv => sv.isActive).length;
            const withPhoto = this.data.sinhviens.filter(sv => sv.hinhAnh).length;
            const withEmbedding = this.data.sinhviens.filter(sv => sv.hasEmbedding).length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('studentsWithPhoto').textContent = withPhoto;
            document.getElementById('studentsWithEmbedding').textContent = withEmbedding;
        },

        goToPage(page) {
            if (page >= 1 && page <= this.data.totalPages && page !== this.data.currentPage) {
                this.data.currentPage = page;
                this.loadData();
            }
        },

        toggleSelect(maSv) {
            if (this.data.selectedIds.has(maSv)) {
                this.data.selectedIds.delete(maSv);
            } else {
                this.data.selectedIds.add(maSv);
            }
            this.updateSelectAllCheckbox();
        },

        toggleSelectAll() {
            const checkbox = document.getElementById('selectAll');
            const isChecked = checkbox.checked;

            if (isChecked) {
                this.data.sinhviens.forEach(sv => this.data.selectedIds.add(sv.maSv));
            } else {
                this.data.selectedIds.clear();
            }

            // Update individual checkboxes
            document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => {
                cb.checked = isChecked;
            });
        },

        updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleIds = this.data.sinhviens.map(sv => sv.maSv);
            const selectedVisibleIds = visibleIds.filter(id => this.data.selectedIds.has(id));

            selectAllCheckbox.checked = selectedVisibleIds.length === visibleIds.length && visibleIds.length > 0;
            selectAllCheckbox.indeterminate = selectedVisibleIds.length > 0 && selectedVisibleIds.length < visibleIds.length;
        },

        showAddModal() {
            this.data.editingId = null;
            this.resetForm();
            document.getElementById('modalTitle').textContent = 'Th√™m sinh vi√™n m·ªõi';
            const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
            modal.show();
        },

        async editSinhVien(maSv) {
            try {
                this.data.editingId = maSv;
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const sinhvien = await response.json();
                this.populateForm(sinhvien);

                document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a sinh vi√™n';
                const modal = new bootstrap.Modal(document.getElementById('sinhvienModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading student for edit:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin sinh vi√™n', 'danger');
            }
        },

        async viewSinhVien(maSv) {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const sinhvien = await response.json();
                this.showViewModal(sinhvien);

            } catch (error) {
                console.error('Error loading student for view:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin sinh vi√™n', 'danger');
            }
        },

        showViewModal(sinhvien) {
            const modalBody = document.getElementById('viewModalBody');
            modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="student-photo-large mb-3">
                                ${sinhvien.hinhAnh ?
                `<img src="${sinhvien.hinhAnh}" alt="${sinhvien.hoTen}" class="img-fluid rounded">` :
                `<div class="photo-placeholder">
                                        <i class="fas fa-user fa-5x"></i>
                                        <p class="mt-2">Ch∆∞a c√≥ ·∫£nh</p>
                                    </div>`
            }
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>M√£ sinh vi√™n:</label>
                                    <span><strong>${sinhvien.maSv}</strong></span>
                                </div>
                                <div class="info-item">
                                    <label>H·ªç v√† t√™n:</label>
                                    <span>${sinhvien.hoTen}</span>
                                </div>
                                <div class="info-item">
                                    <label>Email:</label>
                                    <span>${sinhvien.email || 'Ch∆∞a c√≥'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Gi·ªõi t√≠nh:</label>
                                    <span>${sinhvien.gioiTinh === 'NAM' ? 'Nam' : sinhvien.gioiTinh === 'NU' ? 'N·ªØ' : 'Ch∆∞a x√°c ƒë·ªãnh'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Ng√†y sinh:</label>
                                    <span>${sinhvien.ngaySinh ? new Date(sinhvien.ngaySinh).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥'}</span>
                                </div>
                                <div class="info-item">
                                    <label>L·ªõp:</label>
                                    <span>${sinhvien.tenLop} (${sinhvien.maLop})</span>
                                </div>
                                <div class="info-item">
                                    <label>Tr·∫°ng th√°i:</label>
                                    <span class="badge ${sinhvien.isActive ? 'bg-success' : 'bg-secondary'}">
                                        ${sinhvien.isActive ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <label>D·ªØ li·ªáu nh·∫≠n di·ªán:</label>
                                    <span class="embedding-badge ${sinhvien.hasEmbedding ? 'has-embedding' : 'no-embedding'}">
                                        <i class="fas fa-${sinhvien.hasEmbedding ? 'check-circle' : 'times-circle'}"></i>
                                        ${sinhvien.hasEmbedding ? 'ƒê√£ c√≥' : 'Ch∆∞a c√≥'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            const modal = new bootstrap.Modal(document.getElementById('viewSinhvienModal'));
            modal.show();
        },

        async deleteSinhVien(maSv, hoTen) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n "${hoTen}" (${maSv})?`)) {
                return;
            }

            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete student');

                this.showAlert('X√≥a sinh vi√™n th√†nh c√¥ng!', 'success');
                await this.loadData();

            } catch (error) {
                console.error('Error deleting student:', error);
                this.showAlert('Kh√¥ng th·ªÉ x√≥a sinh vi√™n: ' + error.message, 'danger');
            }
        },

        async manageFaceData(maSv) {
            try {
                this.data.currentStudentId = maSv;

                // Load student info
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}`);
                if (!response.ok) throw new Error('Failed to load student data');

                const sinhvien = await response.json();

                // Update modal with student info
                document.getElementById('faceStudentName').textContent = sinhvien.hoTen;
                document.getElementById('faceStudentId').textContent = sinhvien.maSv;

                const avatar = document.getElementById('faceStudentAvatar');
                if (sinhvien.hinhAnh) {
                    avatar.innerHTML = `<img src="${sinhvien.hinhAnh}" alt="${sinhvien.hoTen}" class="student-avatar">`;
                } else {
                    avatar.innerHTML = `<div class="avatar-placeholder">${sinhvien.hoTen.charAt(0).toUpperCase()}</div>`;
                }

                // Load face images
                await this.loadFaceImages(maSv);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('faceManagementModal'));
                modal.show();

            } catch (error) {
                console.error('Error opening face management:', error);
                this.showAlert('Kh√¥ng th·ªÉ m·ªü qu·∫£n l√Ω d·ªØ li·ªáu khu√¥n m·∫∑t', 'danger');
            }
        },

        async loadFaceImages(maSv) {
            try {
                const response = await fetch(`${this.API_BASE}/sinhvien/${maSv}/face-images`);
                if (response.ok) {
                    this.data.faceImages = await response.json();
                } else {
                    this.data.faceImages = [];
                }

                this.renderFaceImages();
                this.updateExtractionButton();

            } catch (error) {
                console.error('Error loading face images:', error);
                this.data.faceImages = [];
                this.renderFaceImages();
            }
        },

        renderFaceImages() {
            const grid = document.getElementById('faceImagesGrid');
            grid.innerHTML = '';

            // Create 5 slots for face images
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'face-image-slot';

                if (i < this.data.faceImages.length) {
                    const image = this.data.faceImages[i];
                    slot.innerHTML = `
                            <img src="${image.url}" alt="Face ${i + 1}">
                            <button class="remove-btn" onclick="SinhVienManager.removeFaceImage(${i})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                } else {
                    slot.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-plus fa-2x text-muted"></i>
                                <p class="mt-2 text-muted">·∫¢nh ${i + 1}</p>
                            </div>
                        `;
                    slot.onclick = () => document.getElementById('faceImageInput').click();
                }

                grid.appendChild(slot);
            }
        },

        handleFaceImageUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            files.forEach(file => {
                if (this.data.faceImages.length >= 5) {
                    this.showAlert('Ch·ªâ ƒë∆∞·ª£c ph√©p t·∫£i l√™n t·ªëi ƒëa 5 ·∫£nh khu√¥n m·∫∑t', 'warning');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    this.showAlert('Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá', 'warning');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    this.showAlert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'warning');
                    return;
                }

                this.uploadFaceImage(file);
            });

            input.value = '';
        },

        async uploadFaceImage(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('maSv', this.data.currentStudentId);

                const response = await fetch(`${this.API_BASE}/sinhvien/upload-face-image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload face image');

                const result = await response.json();
                this.data.faceImages.push(result);
                this.renderFaceImages();
                this.updateExtractionButton();

            } catch (error) {
                console.error('Error uploading face image:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i l√™n ·∫£nh khu√¥n m·∫∑t', 'danger');
            }
        },

        async removeFaceImage(index) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?')) return;

            try {
                const image = this.data.faceImages[index];
                const response = await fetch(`${this.API_BASE}/sinhvien/face-image/${image.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to remove face image');

                this.data.faceImages.splice(index, 1);
                this.renderFaceImages();
                this.updateExtractionButton();

            } catch (error) {
                console.error('Error removing face image:', error);
                this.showAlert('Kh√¥ng th·ªÉ x√≥a ·∫£nh khu√¥n m·∫∑t', 'danger');
            }
        },

        updateExtractionButton() {
            const btn = document.getElementById('extractFeaturesBtn');
            const hasFiveImages = this.data.faceImages.length === 5;

            btn.disabled = !hasFiveImages;

            if (hasFiveImages) {
                btn.innerHTML = '<i class="fas fa-cogs me-2"></i>Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng';
                btn.className = 'btn btn-success';
            } else {
                btn.innerHTML = `<i class="fas fa-cogs me-2"></i>C·∫ßn ${5 - this.data.faceImages.length} ·∫£nh n·ªØa`;
                btn.className = 'btn btn-secondary';
            }
        },

        async extractFeatures() {
            if (this.data.faceImages.length !== 5) {
                this.showAlert('C·∫ßn ƒë·ªß 5 ·∫£nh khu√¥n m·∫∑t ƒë·ªÉ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng', 'warning');
                return;
            }

            try {
                // Update UI to show processing
                const statusEl = document.getElementById('extractionStatus');
                const progressEl = document.getElementById('extractionProgress');
                const resultsEl = document.getElementById('extractionResults');

                statusEl.className = 'extraction-status status-processing';
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';
                progressEl.style.display = 'block';
                resultsEl.style.display = 'none';

                // Simulate progress
                this.simulateProgress();

                const response = await fetch(`${this.API_BASE}/sinhvien/${this.data.currentStudentId}/extract-features`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to extract features');

                const result = await response.json();

                // Show success
                statusEl.className = 'extraction-status status-completed';
                statusEl.innerHTML = '<i class="fas fa-check-circle me-2"></i>Ho√†n th√†nh';
                progressEl.style.display = 'none';
                resultsEl.style.display = 'block';
                document.getElementById('extractedCount').textContent = this.data.faceImages.length;

                // Update main table
                this.loadData();

            } catch (error) {
                console.error('Error extracting features:', error);

                const statusEl = document.getElementById('extractionStatus');
                statusEl.className = 'extraction-status status-error';
                statusEl.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>L·ªói x·ª≠ l√Ω';

                document.getElementById('extractionProgress').style.display = 'none';
                this.showAlert('Kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng: ' + error.message, 'danger');
            }
        },

        simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            let progress = 0;

            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) {
                    progress = 95;
                    clearInterval(interval);
                }
                progressFill.style.width = progress + '%';
            }, 200);

            return interval;
        },

        resetForm() {
            const form = document.getElementById('sinhvienForm');
            form.reset();

            document.getElementById('maLop').value = '';
            document.getElementById('lopSearch').value = '';
            document.getElementById('hinhAnh').value = '';

            this.hideImagePreview();
            this.clearValidation();
        },

        populateForm(sinhvien) {
            document.getElementById('maSv').value = sinhvien.maSv;
            document.getElementById('hoTen').value = sinhvien.hoTen;
            document.getElementById('email').value = sinhvien.email || '';
            document.getElementById('gioiTinh').value = sinhvien.gioiTinh || '';
            document.getElementById('ngaySinh').value = sinhvien.ngaySinh || '';
            document.getElementById('maLop').value = sinhvien.maLop;
            document.getElementById('isActive').value = sinhvien.isActive.toString();

            // Set class search field
            const selectedClass = this.data.classes.find(lop => lop.maLop === sinhvien.maLop);
            if (selectedClass) {
                document.getElementById('lopSearch').value = selectedClass.tenLop;
            }

            // Set image preview
            if (sinhvien.hinhAnh) {
                this.showImagePreview(sinhvien.hinhAnh);
                document.getElementById('hinhAnh').value = sinhvien.hinhAnh;
            }

            // Disable maSv field for editing
            document.getElementById('maSv').readOnly = !!this.data.editingId;
        },

        async saveSinhVien() {
            const form = document.getElementById('sinhvienForm');
            if (!this.validateForm(form)) return;

            try {
                this.setButtonLoading(true);

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Convert boolean values
                data.isActive = data.isActive === 'true';

                let response;
                if (this.data.editingId) {
                    response = await fetch(`${this.API_BASE}/sinhvien/${this.data.editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${this.API_BASE}/sinhvien`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save student');
                }

                this.showAlert(`${this.data.editingId ? 'C·∫≠p nh·∫≠t' : 'Th√™m'} sinh vi√™n th√†nh c√¥ng!`, 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('sinhvienModal'));
                modal.hide();

                await this.loadData();

            } catch (error) {
                console.error('Error saving student:', error);
                this.showAlert('Kh√¥ng th·ªÉ l∆∞u sinh vi√™n: ' + error.message, 'danger');
            } finally {
                this.setButtonLoading(false);
            }
        },

        validateForm(form) {
            let isValid = true;
            this.clearValidation();

            // Validate required fields
            const requiredFields = ['maSv', 'hoTen', 'maLop'];
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (!field.value.trim()) {
                    this.showFieldError(field, `${field.previousElementSibling.textContent.replace(' *', '')} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng`);
                    isValid = false;
                }
            });

            // Validate email if provided
            const emailField = document.getElementById('email');
            if (emailField.value && !this.isValidEmail(emailField.value)) {
                this.showFieldError(emailField, 'Email kh√¥ng h·ª£p l·ªá');
                isValid = false;
            }

            return isValid;
        },

        isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        },

        showFieldError(field, message) {
            field.classList.add('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = message;
            }
        },

        clearValidation() {
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
        },

        setButtonLoading(loading) {
            const btn = document.querySelector('#sinhvienModal .btn-primary');
            const spinner = btn.querySelector('.loading-spinner');
            const text = btn.querySelector('.btn-text');

            if (loading) {
                spinner.classList.remove('d-none');
                text.textContent = 'ƒêang l∆∞u...';
                btn.disabled = true;
            } else {
                spinner.classList.add('d-none');
                text.textContent = 'L∆∞u';
                btn.disabled = false;
            }
        },

        handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showAlert('Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá', 'warning');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                this.showAlert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'warning');
                return;
            }

            // Upload image
            this.uploadImage(file);
        },

        async uploadImage(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'profile');

                const response = await fetch(`${this.API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload image');

                const result = await response.json();
                this.showImagePreview(result.url);
                document.getElementById('hinhAnh').value = result.url;

            } catch (error) {
                console.error('Error uploading image:', error);
                this.showAlert('Kh√¥ng th·ªÉ t·∫£i l√™n ·∫£nh', 'danger');
            }
        },

        showImagePreview(src) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            img.src = src;
            preview.style.display = 'block';
        },

        hideImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.style.display = 'none';
        },

        handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    this.uploadImage(file);
                } else {
                    this.showAlert('Vui l√≤ng k√©o th·∫£ file ·∫£nh', 'warning');
                }
            }
        },

        handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        },

        handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        },

        // Import/Export Functions
        showImportModal() {
            const modal = new bootstrap.Modal(document.getElementById('importModal'));
            modal.show();
        },

        handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                this.showAlert('Vui l√≤ng ch·ªçn file Excel (.xlsx ho·∫∑c .xls)', 'warning');
                return;
            }

            this.parseExcelFile(file);
        },

        parseExcelFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        this.showAlert('File Excel kh√¥ng c√≥ d·ªØ li·ªáu', 'warning');
                        return;
                    }

                    this.data.importData = jsonData;
                    this.showImportPreview(jsonData);

                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    this.showAlert('Kh√¥ng th·ªÉ ƒë·ªçc file Excel', 'danger');
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showImportPreview(data) {
            const previewDiv = document.getElementById('importPreview');
            const headerEl = document.getElementById('importPreviewHeader');
            const bodyEl = document.getElementById('importPreviewBody');
            const confirmBtn = document.getElementById('confirmImportBtn');

            if (data.length === 0) return;

            // Get headers
            const headers = Object.keys(data[0]);
            headerEl.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

            // Show first 5 rows
            const previewData = data.slice(0, 5);
            bodyEl.innerHTML = previewData.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            previewDiv.style.display = 'block';
            confirmBtn.style.display = 'inline-block';
        },

        async confirmImport() {
            if (!this.data.importData) return;

            try {
                this.showImportProgress();

                const createAccounts = document.getElementById('createAccountsCheck').checked;

                const response = await fetch(`${this.API_BASE}/sinhvien/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: this.data.importData,
                        createAccounts: createAccounts
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Import failed');
                }

                const result = await response.json();

                this.showAlert(`Import th√†nh c√¥ng ${result.successCount} sinh vi√™n!`, 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                modal.hide();

                this.resetImportModal();
                await this.loadData();

            } catch (error) {
                console.error('Error importing data:', error);
                this.showAlert('Kh√¥ng th·ªÉ import d·ªØ li·ªáu: ' + error.message, 'danger');
            } finally {
                this.hideImportProgress();
            }
        },

        showImportProgress() {
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('confirmImportBtn').disabled = true;

            // Simulate progress
            const progressFill = document.getElementById('importProgressFill');
            const statusEl = document.getElementById('importStatus');

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) {
                    progress = 90;
                    clearInterval(interval);
                }
                progressFill.style.width = progress + '%';
                statusEl.textContent = `ƒêang x·ª≠ l√Ω... ${Math.round(progress)}%`;
            }, 300);
        },

        hideImportProgress() {
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = false;
        },

        resetImportModal() {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('excelFile').value = '';
            this.data.importData = null;
        },

        async exportData(format) {
            try {
                const params = new URLSearchParams();
                if (this.data.filters.search) params.append('search', this.data.filters.search);
                if (this.data.filters.class) params.append('class', this.data.filters.class);
                if (this.data.filters.status) params.append('status', this.data.filters.status);

                const response = await fetch(`${this.API_BASE}/sinhvien/export/${format}?${params}`);
                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `danh-sach-sinh-vien.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error exporting data:', error);
                this.showAlert('Kh√¥ng th·ªÉ xu·∫•t d·ªØ li·ªáu', 'danger');
            }
        },

        async refreshData() {
            await this.loadData();
            this.showAlert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'info');
        },

        showTableLoading(show) {
            const tbody = document.getElementById('sinhvienTableBody');
            if (show) {
                tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                            </td>
                        </tr>
                    `;
            }
        },

        showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

            document.body.appendChild(alertDiv);

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        SinhVienManager.init();
    });
</script>
</body>
</html>