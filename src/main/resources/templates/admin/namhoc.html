<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Năm học - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1c6681;
            --primary-light: #e8f4f8;
            --success-color: #27ae60;
            --success-light: #e8f8f0;
            --warning-color: #f39c12;
            --warning-light: #fef9e7;
            --danger-color: #e74c3c;
            --danger-light: #fdf2f2;
            --info-color: #3498db;
            --info-light: #e8f4fd;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            background-color: var(--gray-50);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Header Styles */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 24px 24px;
        }

        .page-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .page-title-section h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .page-actions .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .page-actions .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1.5rem;
        }

        .stats-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
        }

        .stats-card.primary::before { background: var(--primary-color); }
        .stats-card.success::before { background: var(--success-color); }
        .stats-card.warning::before { background: var(--warning-color); }
        .stats-card.info::before { background: var(--info-color); }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stats-card-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stats-card.primary .stats-icon {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .stats-card.success .stats-icon {
            background: var(--success-light);
            color: var(--success-color);
        }

        .stats-card.warning .stats-icon {
            background: var(--warning-light);
            color: var(--warning-color);
        }

        .stats-card.info .stats-icon {
            background: var(--info-light);
            color: var(--info-color);
        }

        .stats-content {
            text-align: right;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stats-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Content Container */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Filters Section */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
        }

        .filters-content {
            display: flex;
            gap: 1.5rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 200px;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin: 0;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(28, 102, 129, 0.1);
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        .filter-actions {
            display: flex;
            gap: 0.75rem;
            margin-left: auto;
        }

        .btn {
            border-radius: 10px;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .btn-outline-secondary {
            color: var(--gray-600);
            border-color: var(--gray-300);
        }

        .btn-outline-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
            color: var(--gray-700);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Table Section */
        .table-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .result-count {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-700);
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table tbody td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        .sort-btn {
            background: none;
            border: none;
            color: inherit;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            text-align: left;
            padding: 0;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sort-btn:hover {
            color: var(--primary-color);
        }

        .sort-icon {
            font-size: 0.75rem;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .sort-icon.active {
            opacity: 1;
            color: var(--primary-color);
        }

        /* Year Info */
        .year-code {
            font-weight: 700;
            color: var(--gray-900);
            font-size: 1rem;
        }

        .year-detail {
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            gap: 0.375rem;
        }

        .status-badge.active {
            background: var(--success-light);
            color: var(--success-color);
        }

        .status-badge.inactive {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 0.5rem;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-outline-danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-outline-danger:hover {
            background: var(--danger-color);
            color: white;
            transform: translateY(-1px);
        }

        /* Loading States */
        .loading-container {
            padding: 4rem 2rem;
            text-align: center;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--gray-500);
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-content {
            max-width: 400px;
            margin: 0 auto;
        }

        .empty-content i {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }

        .empty-content h6 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-content p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        /* Error State */
        .error-container {
            padding: 4rem 2rem;
            text-align: center;
        }

        .error-content {
            max-width: 400px;
            margin: 0 auto;
        }

        .error-content i {
            font-size: 4rem;
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .error-content h6 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .error-content p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        /* Modal Styles */
        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            display: block;
        }

        .required::after {
            content: ' *';
            color: var(--danger-color);
        }

        .form-help {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .form-help i {
            font-size: 0.75rem;
            color: var(--info-color);
        }

        .is-invalid {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }

        .is-valid {
            border-color: var(--success-color) !important;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1) !important;
        }

        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
        }

        /* Delete Modal */
        .delete-confirmation {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .warning-icon {
            font-size: 3rem;
            color: var(--danger-color);
            flex-shrink: 0;
        }

        .warning-content h6 {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .warning-text {
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .warning-note {
            background: var(--warning-light);
            color: var(--warning-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
            font-size: 0.875rem;
            margin: 0;
        }

        /* Alert Floating */
        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 350px;
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header-content {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 0 1rem;
            }

            .content-container {
                padding: 0 1rem;
            }

            .filters-content {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                min-width: auto;
            }

            .filter-actions {
                margin-left: 0;
                justify-content: stretch;
            }

            .filter-actions .btn {
                flex: 1;
            }

            .table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }

            .delete-confirmation {
                flex-direction: column;
                text-align: center;
            }

            .alert-floating {
                left: 1rem;
                right: 1rem;
                min-width: auto;
            }
        }

        @media (max-width: 576px) {
            .page-header {
                padding: 1.5rem 0;
            }

            .page-title-section h2 {
                font-size: 1.5rem;
            }

            .stats-card {
                padding: 1rem;
            }

            .stats-number {
                font-size: 1.5rem;
            }

            .table thead th,
            .table tbody td {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }

            .action-buttons .btn {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <div class="page-title-section">
                    <h2>Quản lý Năm học</h2>
                    <p class="page-subtitle">Quản lý danh sách năm học trong hệ thống điểm danh</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-primary" onclick="showCreateModal()">
                        <i class="fas fa-plus me-2"></i>Thêm năm học
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stats-card primary">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <div class="stats-number" id="totalYears">0</div>
                        <div class="stats-label">Tổng số năm học</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card success">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <div class="stats-number" id="activeYears">0</div>
                        <div class="stats-label">Năm học đang hoạt động</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card warning">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <div class="stats-number" id="currentYear">---</div>
                        <div class="stats-label">Năm học hiện tại</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card info">
                <div class="stats-card-content">
                    <div class="stats-info">
                        <div class="stats-number" id="latestYear">---</div>
                        <div class="stats-label">Năm học mới nhất</div>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Filters -->
            <div class="filters-section">
                <div class="filters-content">
                    <div class="filter-group">
                        <label class="filter-label">Trạng thái</label>
                        <select class="form-select" id="statusFilter" onchange="applyFilters()">
                            <option value="">Tất cả</option>
                            <option value="true">Đang hoạt động</option>
                            <option value="false">Ngừng hoạt động</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tìm kiếm</label>
                        <div class="search-input-wrapper">
                            <input type="text" class="form-control" id="searchInput"
                                   placeholder="Tìm theo mã năm học..."
                                   onkeyup="applyFilters()">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Xóa bộ lọc
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>Xuất Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-section">
                <div class="table-header">
                    <h5 class="table-title">Danh sách năm học</h5>
                    <div class="table-info">
                        <span class="result-count">Hiển thị <span id="displayCount">0</span> / <span id="totalCount">0</span> kết quả</span>
                    </div>
                </div>

                <div class="table-container">
                    <div id="loadingSpinner" class="loading-container">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Đang tải dữ liệu...</span>
                        </div>
                    </div>

                    <div id="errorContainer" class="error-container d-none">
                        <div class="error-content">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h6>Không thể tải dữ liệu</h6>
                            <p>Vui lòng thử lại sau hoặc liên hệ quản trị viên.</p>
                            <button class="btn btn-primary" onclick="loadData()">
                                <i class="fas fa-redo me-2"></i>Thử lại
                            </button>
                        </div>
                    </div>

                    <div id="tableContainer" class="table-responsive">
                        <table class="table table-hover" id="namhocTable">
                            <thead>
                            <tr>
                                <th>
                                    <button class="sort-btn" onclick="sortTable('maNamHoc')">
                                        Mã năm học <i class="fas fa-sort sort-icon"></i>
                                    </button>
                                </th>
                                <th>Năm bắt đầu</th>
                                <th>Năm kết thúc</th>
                                <th>
                                    <button class="sort-btn" onclick="sortTable('isActive')">
                                        Trạng thái <i class="fas fa-sort sort-icon"></i>
                                    </button>
                                </th>
                            </tr>
                            </thead>
                            <tbody id="namhocTableBody">
                            <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="emptyState" class="empty-state d-none">
                        <div class="empty-content">
                            <i class="fas fa-calendar-alt"></i>
                            <h6>Chưa có năm học nào</h6>
                            <p>Bắt đầu bằng cách thêm năm học đầu tiên.</p>
                            <button class="btn btn-primary" onclick="showCreateModal()">
                                <i class="fas fa-plus me-2"></i>Thêm năm học
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="namhocModal" tabindex="-1" aria-labelledby="namhocModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="namhocModalLabel">Thêm năm học mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="namhocForm">
                <div class="modal-body">
                    <div class="form-content">
                        <!-- Mã năm học -->
                        <div class="form-group">
                            <label class="form-label required" for="maNamHoc">Mã năm học</label>
                            <input type="text" class="form-control" id="maNamHoc" name="maNamHoc"
                                   placeholder="Ví dụ: 2023-2024"
                                   maxlength="20" required>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Nhập theo định dạng: YYYY-YYYY (ví dụ: 2023-2024)
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- Trạng thái -->
                        <div class="form-group">
                            <label class="form-label" for="isActive">Trạng thái</label>
                            <select class="form-select" id="isActive" name="isActive">
                                <option value="true">Đang hoạt động</option>
                                <option value="false">Ngừng hoạt động</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Chỉ các năm học đang hoạt động mới được sử dụng trong hệ thống
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-content">
                        <h6>Bạn có chắc chắn muốn xóa năm học này?</h6>
                        <p class="warning-text">Năm học: <strong id="deleteYearName">---</strong></p>
                        <p class="warning-note">
                            <i class="fas fa-info-circle me-2"></i>
                            Thao tác này không thể hoàn tác!
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-outline-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Xóa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/admin.js}"></script>

<script>
    // ===== CONFIGURATION =====
    const API_BASE = '/api/namhoc';
    let namhocData = [];
    let filteredData = [];
    let currentSort = { field: 'maNamHoc', direction: 'asc' };
    let isEditing = false;
    let currentEditId = null;

    // ===== PAGE INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing Nam hoc Management Page');

        initializeEventListeners();
        loadData();
    });

    function initializeEventListeners() {
        // Form submission
        document.getElementById('namhocForm').addEventListener('submit', handleFormSubmit);

        // Delete confirmation
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDelete);

        // Modal events
        document.getElementById('namhocModal').addEventListener('hidden.bs.modal', resetForm);

        // Real-time validation
        setupFormValidation();

        console.log('✅ Event listeners initialized');
    }

    function setupFormValidation() {
        const maNamHocInput = document.getElementById('maNamHoc');

        maNamHocInput.addEventListener('input', function() {
            validateMaNamHoc(this.value);
        });

        maNamHocInput.addEventListener('blur', function() {
            validateMaNamHoc(this.value);
        });
    }

    // ===== DATA LOADING =====
    async function loadData() {
        try {
            showLoading(true);
            console.log('📡 Loading nam hoc data...');

            const response = await fetch(API_BASE);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            namhocData = await response.json();
            console.log('✅ Nam hoc data loaded:', namhocData.length);

            applyFilters();
            updateStats();
            showContent();

        } catch (error) {
            console.error('❌ Error loading data:', error);
            showError();
        } finally {
            showLoading(false);
        }
    }

    function updateStats() {
        const total = namhocData.length;
        const active = namhocData.filter(item => item.isActive).length;

        // Find current and latest year
        const currentYear = findCurrentYear();
        const latestYear = findLatestYear();

        document.getElementById('totalYears').textContent = total;
        document.getElementById('activeYears').textContent = active;
        document.getElementById('currentYear').textContent = currentYear || '---';
        document.getElementById('latestYear').textContent = latestYear || '---';
    }

    function findCurrentYear() {
        const currentYear = new Date().getFullYear();
        const current = namhocData.find(item => {
            if (!item.maNamHoc.includes('-')) return false;
            const [startYear] = item.maNamHoc.split('-').map(y => parseInt(y.trim()));
            return startYear === currentYear && item.isActive;
        });
        return current?.maNamHoc;
    }

    function findLatestYear() {
        if (namhocData.length === 0) return null;

        const sorted = [...namhocData].sort((a, b) => {
            const aYear = extractYearFromCode(a.maNamHoc);
            const bYear = extractYearFromCode(b.maNamHoc);
            return bYear - aYear;
        });

        return sorted[0]?.maNamHoc;
    }

    function extractYearFromCode(maNamHoc) {
        if (!maNamHoc.includes('-')) return 0;
        const [startYear] = maNamHoc.split('-').map(y => parseInt(y.trim()));
        return startYear || 0;
    }

    // ===== FILTERING & SEARCHING =====
    function applyFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

        filteredData = namhocData.filter(item => {
            // Status filter
            if (statusFilter !== '' && item.isActive.toString() !== statusFilter) {
                return false;
            }

            // Search filter
            if (searchTerm && !item.maNamHoc.toLowerCase().includes(searchTerm)) {
                return false;
            }

            return true;
        });

        // Apply current sort
        sortData();
        renderTable();
        updateResultCount();
    }

    function clearFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        applyFilters();
    }

    function updateResultCount() {
        document.getElementById('displayCount').textContent = filteredData.length;
        document.getElementById('totalCount').textContent = namhocData.length;
    }

    // ===== SORTING =====
    function sortTable(field) {
        if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
        }

        updateSortIcons();
        sortData();
        renderTable();
    }

    function sortData() {
        filteredData.sort((a, b) => {
            let aVal = a[currentSort.field];
            let bVal = b[currentSort.field];

            if (currentSort.field === 'maNamHoc') {
                // Sort by year for academic year codes
                aVal = extractYearFromCode(aVal);
                bVal = extractYearFromCode(bVal);
            }

            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.className = 'fas fa-sort sort-icon';
        });

        const activeButton = document.querySelector(`[onclick="sortTable('${currentSort.field}')"] .sort-icon`);
        if (activeButton) {
            activeButton.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} sort-icon active`;
        }
    }

    // ===== TABLE RENDERING =====
    function renderTable() {
        const tbody = document.getElementById('namhocTableBody');

        if (filteredData.length === 0) {
            showEmptyState();
            return;
        }

        hideEmptyState();

        const html = filteredData.map(item => {
            const yearInfo = parseAcademicYear(item.maNamHoc);

            return `
            <tr>
                <td>
                    <div class="year-info">
                        <span class="year-code">${escapeHtml(item.maNamHoc)}</span>
                    </div>
                </td>
                <td>
                    <span class="year-detail">${yearInfo.startYear}</span>
                </td>
                <td>
                    <span class="year-detail">${yearInfo.endYear}</span>
                </td>
                <td>
                    <span class="status-badge ${item.isActive ? 'active' : 'inactive'}">
                        <i class="fas ${item.isActive ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        ${item.isActive ? 'Đang hoạt động' : 'Ngừng hoạt động'}
                    </span>
                </td>
                </td>
            </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    function parseAcademicYear(maNamHoc) {
        if (maNamHoc.includes('-')) {
            const [start, end] = maNamHoc.split('-').map(y => y.trim());
            return { startYear: start, endYear: end };
        }
        return { startYear: maNamHoc, endYear: '---' };
    }

    // ===== MODAL MANAGEMENT =====
    function showCreateModal() {
        isEditing = false;
        currentEditId = null;

        document.getElementById('namhocModalLabel').textContent = 'Thêm năm học mới';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i>Lưu';

        resetForm();

        const modal = new bootstrap.Modal(document.getElementById('namhocModal'));
        modal.show();

        // Focus on first input
        setTimeout(() => {
            document.getElementById('maNamHoc').focus();
        }, 500);
    }

    function editNamHoc(maNamHoc) {
        const item = namhocData.find(n => n.maNamHoc === maNamHoc);
        if (!item) {
            showAlert('Không tìm thấy năm học!', 'error');
            return;
        }

        isEditing = true;
        currentEditId = maNamHoc;

        document.getElementById('namhocModalLabel').textContent = 'Chỉnh sửa năm học';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i>Cập nhật';

        // Populate form
        document.getElementById('maNamHoc').value = item.maNamHoc;
        document.getElementById('isActive').value = item.isActive.toString();

        // Disable maNamHoc when editing
        document.getElementById('maNamHoc').disabled = true;

        const modal = new bootstrap.Modal(document.getElementById('namhocModal'));
        modal.show();
    }

    function resetForm() {
        document.getElementById('namhocForm').reset();
        document.getElementById('maNamHoc').disabled = false;

        // Clear validation states
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });

        // Set default values
        document.getElementById('isActive').value = 'true';
    }

    // ===== FORM SUBMISSION =====
    async function handleFormSubmit(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        const formData = new FormData(e.target);
        const data = {
            maNamHoc: formData.get('maNamHoc').trim(),
            isActive: formData.get('isActive') === 'true'
        };

        try {
            showLoading(true);

            let response;
            if (isEditing) {
                response = await fetch(`${API_BASE}/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('namhocModal'));
            modal.hide();

            showAlert(isEditing ? 'Cập nhật năm học thành công!' : 'Thêm năm học thành công!', 'success');
            await loadData();

        } catch (error) {
            console.error('❌ Error saving:', error);
            showAlert('Có lỗi xảy ra: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    // ===== VALIDATION =====
    function validateForm() {
        let isValid = true;

        // Validate maNamHoc
        const maNamHoc = document.getElementById('maNamHoc').value.trim();
        if (!validateMaNamHoc(maNamHoc)) {
            isValid = false;
        }

        return isValid;
    }

    function validateMaNamHoc(value) {
        const input = document.getElementById('maNamHoc');
        const feedback = input.nextElementSibling.nextElementSibling; // Skip .form-help

        if (!value) {
            showFieldError(input, feedback, 'Vui lòng nhập mã năm học');
            return false;
        }

        if (value.length > 20) {
            showFieldError(input, feedback, 'Mã năm học không được quá 20 ký tự');
            return false;
        }

        // Validate format YYYY-YYYY
        const pattern = /^\d{4}-\d{4}$/;
        if (!pattern.test(value)) {
            showFieldError(input, feedback, 'Mã năm học phải có định dạng YYYY-YYYY (ví dụ: 2023-2024)');
            return false;
        }

        const [startYear, endYear] = value.split('-').map(y => parseInt(y));
        if (endYear !== startYear + 1) {
            showFieldError(input, feedback, 'Năm kết thúc phải bằng năm bắt đầu + 1');
            return false;
        }

        // Check duplicate (only when creating new)
        if (!isEditing && namhocData.some(item => item.maNamHoc === value)) {
            showFieldError(input, feedback, 'Mã năm học đã tồn tại');
            return false;
        }

        showFieldSuccess(input, feedback);
        return true;
    }

    function showFieldError(input, feedback, message) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        feedback.textContent = message;
        feedback.style.display = 'block';
    }

    function showFieldSuccess(input, feedback) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.style.display = 'none';
    }

    // ===== DELETE FUNCTIONALITY =====
    function confirmDelete(maNamHoc) {
        const item = namhocData.find(n => n.maNamHoc === maNamHoc);
        if (!item) return;

        document.getElementById('deleteYearName').textContent = item.maNamHoc;
        currentEditId = maNamHoc;

        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    async function handleDelete() {
        if (!currentEditId) return;

        try {
            showLoading(true);

            const response = await fetch(`${API_BASE}/${currentEditId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            showAlert('Xóa năm học thành công!', 'success');
            await loadData();

        } catch (error) {
            console.error('❌ Error deleting:', error);
            showAlert('Có lỗi xảy ra khi xóa: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    // ===== EXPORT FUNCTIONALITY =====
    async function exportData() {
        try {
            showLoading(true);

            const response = await fetch(`${API_BASE}/export`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                }
            });

            if (!response.ok) {
                throw new Error('Không thể xuất dữ liệu');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `danh-sach-nam-hoc-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showAlert('Xuất dữ liệu thành công!', 'success');

        } catch (error) {
            console.error('❌ Error exporting:', error);
            showAlert('Có lỗi xảy ra khi xuất dữ liệu: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    // ===== UI STATE MANAGEMENT =====
    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const tableContainer = document.getElementById('tableContainer');
        const errorContainer = document.getElementById('errorContainer');

        if (show) {
            spinner.classList.remove('d-none');
            tableContainer.classList.add('d-none');
            errorContainer.classList.add('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    function showContent() {
        const tableContainer = document.getElementById('tableContainer');
        const errorContainer = document.getElementById('errorContainer');

        tableContainer.classList.remove('d-none');
        errorContainer.classList.add('d-none');
    }

    function showError() {
        const tableContainer = document.getElementById('tableContainer');
        const errorContainer = document.getElementById('errorContainer');

        tableContainer.classList.add('d-none');
        errorContainer.classList.remove('d-none');
    }

    function showEmptyState() {
        const tableContainer = document.getElementById('tableContainer');
        const emptyState = document.getElementById('emptyState');

        tableContainer.classList.add('d-none');
        emptyState.classList.remove('d-none');
    }

    function hideEmptyState() {
        const tableContainer = document.getElementById('tableContainer');
        const emptyState = document.getElementById('emptyState');

        tableContainer.classList.remove('d-none');
        emptyState.classList.add('d-none');
    }

    // ===== UTILITY FUNCTIONS =====
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(message, type = 'info') {
        // Remove existing alerts
        document.querySelectorAll('.alert-floating').forEach(alert => {
            alert.remove();
        });

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-floating`;
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;

        document.body.appendChild(alertDiv);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + N: New year
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            showCreateModal();
        }

        // Escape: Close modals
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) instance.hide();
            });
        }

        // Enter in search: Focus table
        if (e.key === 'Enter' && e.target.id === 'searchInput') {
            e.preventDefault();
            const firstRow = document.querySelector('#namhocTableBody tr');
            if (firstRow) {
                firstRow.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });

    console.log('✅ Nam hoc Management Script Loaded');
</script>

</body>
</html>
